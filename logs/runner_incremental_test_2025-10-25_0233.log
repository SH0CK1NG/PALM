nohup: ignoring input
==== Stage 1: forget_inc={0,8,11,40,51}; forget_seen={}; all={0,8,11,40,51,66,67,88,94,57} ====
/home/shaokun/anaconda3/envs/PPALM/lib/python3.10/site-packages/torchvision/io/image.py:13: UserWarning: Failed to load image Python extension: '/home/shaokun/anaconda3/envs/PPALM/lib/python3.10/site-packages/torchvision/image.so: undefined symbol: _ZN3c1017RegisterOperatorsD1Ev'If you don't plan on using image functionality from `torchvision.io`, you can ignore this warning. Otherwise, there might be something wrong with your environment. Did you have `libjpeg` or `libpng` installed before building `torchvision` from source?
  warn(
/home/shaokun/PALM/main.py:54: FutureWarning: `torch.cuda.amp.GradScaler(args...)` is deprecated. Please use `torch.amp.GradScaler('cuda', args...)` instead.
  scaler = torch.cuda.amp.GradScaler()
Namespace(in_dataset='CIFAR-100', out_datasets=['inat', 'sun50', 'places50', 'dtd'], backbone='resnet34', method='top5-palm-cache6-ema0.999', seed=1, gpu='0', epochs=5, batch_size=128, lr=0.001, weight_decay=0.0001, print_every=50, fine_tune=False, temp=0.08, cosine=True, warm=False, lr_decay_epochs='700,800,900', lr_decay_rate=0.1, layers=100, depth=40, width=4, growth=12, droprate=0.0, save_path='CIFAR-10-ResNet18.pt', load_path='checkpoints/CIFAR-100-resnet34-top5-palm-cache6-ema0.999-with-prototypes.pt', reduce=0.5, score='mahalanobis', threshold=1.0, k=5, momentum=0.9, proto_m=0.999, cache_size=6, nviews=2, lambda_pcon=1.0, epsilon=0.05, incremental=False, use_lora=True, lora_impl='peft', lora_r=8, lora_alpha=32, lora_dropout=0.05, lora_target='both', adapter_save_path='checkpoints/CIFAR-100-resnet34-top5-palm-cache6-ema0.999-b128-e5-lr0.001-wd1e-4-ltboth-bfmbalanced-fl0.2-lora_r8a32d0.05-temp0.08-stack/stage1', adapter_load_path=None, adapter_load_paths=None, lora_new_adapter_name=None, lora_stack=False, lora_orth_enable=False, lora_orth_lambda=0.1, lora_orth_ref_paths=None, forget_classes='0,8,11,40,51,66,67,88,94,57', forget_list_path=None, forget_classes_inc='0,8,11,40,51', forget_classes_seen=None, retain_exclude_csv=None, forget_csv=None, forget_lambda=0.2, forget_margin=100.0, forget_strategy='proto', centers_path=None, precision_path=None, batch_forget_mode='balanced', forget_proto_enable=False, forget_attr_w=1.0, forget_proto_rep_w=1.0, forget_avgproto_enable=False, forget_avgproto_w=1.0, umap_enable=False, umap_by='domain', umap_max_points=20000, umap_neighbors=15, umap_min_dist=0.05, umap_metric='cosine', umap_save_path=None, umap_rf_only=False, keep_cache=False, argument=True)
Files already downloaded and verified
ckpt loaded from checkpoints/CIFAR-100-resnet34-top5-palm-cache6-ema0.999-with-prototypes.pt
resnet34-top5-palm-cache6-ema0.999: Number of model parameters: 21843904
[debug] trainable_count = 16
[debug] trainable: base_model.model.encoder.layer4.0.conv1.lora_A.default.weight
[debug] trainable: base_model.model.encoder.layer4.0.conv1.lora_B.default.weight
[debug] trainable: base_model.model.encoder.layer4.0.conv2.lora_A.default.weight
[debug] trainable: base_model.model.encoder.layer4.0.conv2.lora_B.default.weight
[debug] trainable: base_model.model.encoder.layer4.0.shortcut.0.lora_A.default.weight
[debug] trainable: base_model.model.encoder.layer4.0.shortcut.0.lora_B.default.weight
[debug] trainable: base_model.model.encoder.layer4.1.conv1.lora_A.default.weight
[debug] trainable: base_model.model.encoder.layer4.1.conv1.lora_B.default.weight
[debug] trainable: base_model.model.encoder.layer4.1.conv2.lora_A.default.weight
[debug] trainable: base_model.model.encoder.layer4.1.conv2.lora_B.default.weight
[debug] trainable: base_model.model.encoder.layer4.2.conv1.lora_A.default.weight
[debug] trainable: base_model.model.encoder.layer4.2.conv1.lora_B.default.weight
[debug] trainable: base_model.model.encoder.layer4.2.conv2.lora_A.default.weight
[debug] trainable: base_model.model.encoder.layer4.2.conv2.lora_B.default.weight
[debug] trainable: base_model.model.head.2.lora_A.default.weight
[debug] trainable: base_model.model.head.2.lora_B.default.weight
[debug][warn] non-LoRA trainables detected: ['base_model.model.encoder.layer4.0.conv1.lora_A.default.weight', 'base_model.model.encoder.layer4.0.conv1.lora_B.default.weight', 'base_model.model.encoder.layer4.0.conv2.lora_A.default.weight', 'base_model.model.encoder.layer4.0.conv2.lora_B.default.weight', 'base_model.model.encoder.layer4.0.shortcut.0.lora_A.default.weight', 'base_model.model.encoder.layer4.0.shortcut.0.lora_B.default.weight', 'base_model.model.encoder.layer4.1.conv1.lora_A.default.weight', 'base_model.model.encoder.layer4.1.conv1.lora_B.default.weight', 'base_model.model.encoder.layer4.1.conv2.lora_A.default.weight', 'base_model.model.encoder.layer4.1.conv2.lora_B.default.weight']
  0%|          | 0/5 [00:00<?, ?it/s]/home/shaokun/PALM/trainer.py:139: FutureWarning: `torch.cuda.amp.autocast(args...)` is deprecated. Please use `torch.amp.autocast('cuda', args...)` instead.
  with torch.cuda.amp.autocast():
 20%|██        | 1/5 [02:34<10:18, 154.65s/it] 40%|████      | 2/5 [03:19<04:29, 89.85s/it]  60%|██████    | 3/5 [03:58<02:13, 66.81s/it] 80%|████████  | 4/5 [04:44<00:58, 58.74s/it]100%|██████████| 5/5 [05:24<00:00, 51.73s/it]100%|██████████| 5/5 [05:24<00:00, 64.84s/it]
[loss] ep 0 it 0 total=8.4093 mle=1.6263 pcon=5.2951 forget=1.4879 favg=0.0000 nr=28 nf=28 protos=570 fproto_sim=NA
[loss] ep 0 it 50 total=8.7559 mle=1.9939 pcon=5.2910 forget=1.4711 favg=0.0000 nr=30 nf=30 protos=570 fproto_sim=NA
[loss] ep 0 it 100 total=8.8804 mle=2.1358 pcon=5.2868 forget=1.4578 favg=0.0000 nr=30 nf=30 protos=570 fproto_sim=NA
[loss] ep 0 it 150 total=9.2340 mle=2.4866 pcon=5.2829 forget=1.4645 favg=0.0000 nr=32 nf=32 protos=570 fproto_sim=NA
[loss] ep 0 it 200 total=9.2721 mle=2.5439 pcon=5.2787 forget=1.4496 favg=0.0000 nr=30 nf=30 protos=570 fproto_sim=NA
[loss] ep 0 it 250 total=8.6733 mle=1.9322 pcon=5.2747 forget=1.4663 favg=0.0000 nr=34 nf=34 protos=570 fproto_sim=NA
[loss] ep 0 it 300 total=8.4971 mle=1.7803 pcon=5.2707 forget=1.4461 favg=0.0000 nr=30 nf=30 protos=570 fproto_sim=NA
[loss] ep 0 it 350 total=9.0516 mle=2.3357 pcon=5.2667 forget=1.4491 favg=0.0000 nr=34 nf=34 protos=570 fproto_sim=NA
[peft] adapter saved to checkpoints/CIFAR-100-resnet34-top5-palm-cache6-ema0.999-b128-e5-lr0.001-wd1e-4-ltboth-bfmbalanced-fl0.2-lora_r8a32d0.05-temp0.08-stack/stage1
[loss] ep 1 it 10 total=8.3919 mle=1.6597 pcon=5.2628 forget=1.4694 favg=0.0000 nr=41 nf=41 protos=570 fproto_sim=NA
[loss] ep 1 it 60 total=8.3577 mle=1.6499 pcon=5.2589 forget=1.4488 favg=0.0000 nr=26 nf=26 protos=570 fproto_sim=NA
[loss] ep 1 it 110 total=8.4052 mle=1.6984 pcon=5.2552 forget=1.4516 favg=0.0000 nr=30 nf=30 protos=570 fproto_sim=NA
[loss] ep 1 it 160 total=8.5323 mle=1.7845 pcon=5.2515 forget=1.4963 favg=0.0000 nr=32 nf=32 protos=570 fproto_sim=NA
[loss] ep 1 it 210 total=8.2692 mle=1.5551 pcon=5.2477 forget=1.4663 favg=0.0000 nr=32 nf=32 protos=570 fproto_sim=NA
[loss] ep 1 it 260 total=8.7198 mle=2.0035 pcon=5.2439 forget=1.4724 favg=0.0000 nr=30 nf=30 protos=570 fproto_sim=NA
[loss] ep 1 it 310 total=8.9394 mle=2.2291 pcon=5.2404 forget=1.4699 favg=0.0000 nr=36 nf=36 protos=570 fproto_sim=NA
[loss] ep 1 it 360 total=8.5480 mle=1.8692 pcon=5.2366 forget=1.4422 favg=0.0000 nr=33 nf=33 protos=570 fproto_sim=NA
[peft] adapter saved to checkpoints/CIFAR-100-resnet34-top5-palm-cache6-ema0.999-b128-e5-lr0.001-wd1e-4-ltboth-bfmbalanced-fl0.2-lora_r8a32d0.05-temp0.08-stack/stage1
[loss] ep 2 it 20 total=8.0428 mle=1.3555 pcon=5.2331 forget=1.4542 favg=0.0000 nr=38 nf=38 protos=570 fproto_sim=NA
[loss] ep 2 it 70 total=8.4406 mle=1.8001 pcon=5.2298 forget=1.4107 favg=0.0000 nr=32 nf=32 protos=570 fproto_sim=NA
[loss] ep 2 it 120 total=8.3370 mle=1.6574 pcon=5.2262 forget=1.4534 favg=0.0000 nr=40 nf=40 protos=570 fproto_sim=NA
[loss] ep 2 it 170 total=8.7017 mle=2.0436 pcon=5.2228 forget=1.4353 favg=0.0000 nr=24 nf=24 protos=570 fproto_sim=NA
[loss] ep 2 it 220 total=9.0536 mle=2.4072 pcon=5.2195 forget=1.4270 favg=0.0000 nr=27 nf=27 protos=570 fproto_sim=NA
[loss] ep 2 it 270 total=8.4798 mle=1.8171 pcon=5.2162 forget=1.4465 favg=0.0000 nr=35 nf=35 protos=570 fproto_sim=NA
[loss] ep 2 it 320 total=8.2502 mle=1.5929 pcon=5.2130 forget=1.4443 favg=0.0000 nr=33 nf=33 protos=570 fproto_sim=NA
[loss] ep 2 it 370 total=8.6808 mle=2.0344 pcon=5.2098 forget=1.4367 favg=0.0000 nr=29 nf=29 protos=570 fproto_sim=NA
[peft] adapter saved to checkpoints/CIFAR-100-resnet34-top5-palm-cache6-ema0.999-b128-e5-lr0.001-wd1e-4-ltboth-bfmbalanced-fl0.2-lora_r8a32d0.05-temp0.08-stack/stage1
[loss] ep 3 it 30 total=8.2828 mle=1.6334 pcon=5.2065 forget=1.4429 favg=0.0000 nr=28 nf=28 protos=570 fproto_sim=NA
[loss] ep 3 it 80 total=8.7732 mle=2.0479 pcon=5.2032 forget=1.5221 favg=0.0000 nr=34 nf=34 protos=570 fproto_sim=NA
[loss] ep 3 it 130 total=8.5103 mle=1.9326 pcon=5.2003 forget=1.3775 favg=0.0000 nr=30 nf=30 protos=570 fproto_sim=NA
[loss] ep 3 it 180 total=8.7388 mle=2.1008 pcon=5.1969 forget=1.4410 favg=0.0000 nr=41 nf=41 protos=570 fproto_sim=NA
[loss] ep 3 it 230 total=8.4277 mle=1.8242 pcon=5.1937 forget=1.4099 favg=0.0000 nr=32 nf=32 protos=570 fproto_sim=NA
[loss] ep 3 it 280 total=8.4482 mle=1.8525 pcon=5.1909 forget=1.4049 favg=0.0000 nr=33 nf=33 protos=570 fproto_sim=NA
[loss] ep 3 it 330 total=8.7577 mle=2.0952 pcon=5.1880 forget=1.4746 favg=0.0000 nr=25 nf=25 protos=570 fproto_sim=NA
[loss] ep 3 it 380 total=8.3134 mle=1.6390 pcon=5.1849 forget=1.4895 favg=0.0000 nr=29 nf=29 protos=570 fproto_sim=NA
[peft] adapter saved to checkpoints/CIFAR-100-resnet34-top5-palm-cache6-ema0.999-b128-e5-lr0.001-wd1e-4-ltboth-bfmbalanced-fl0.2-lora_r8a32d0.05-temp0.08-stack/stage1
[loss] ep 4 it 40 total=8.5239 mle=1.8600 pcon=5.1821 forget=1.4819 favg=0.0000 nr=34 nf=34 protos=570 fproto_sim=NA
[loss] ep 4 it 90 total=8.2765 mle=1.7144 pcon=5.1790 forget=1.3831 favg=0.0000 nr=41 nf=41 protos=570 fproto_sim=NA
[loss] ep 4 it 140 total=9.0109 mle=2.3584 pcon=5.1762 forget=1.4764 favg=0.0000 nr=33 nf=33 protos=570 fproto_sim=NA
[loss] ep 4 it 190 total=8.4974 mle=1.8555 pcon=5.1731 forget=1.4688 favg=0.0000 nr=25 nf=25 protos=570 fproto_sim=NA
[loss] ep 4 it 240 total=8.4982 mle=1.8218 pcon=5.1701 forget=1.5063 favg=0.0000 nr=28 nf=28 protos=570 fproto_sim=NA
[loss] ep 4 it 290 total=8.2817 mle=1.7156 pcon=5.1672 forget=1.3989 favg=0.0000 nr=29 nf=29 protos=570 fproto_sim=NA
[loss] ep 4 it 340 total=8.6378 mle=2.0380 pcon=5.1643 forget=1.4354 favg=0.0000 nr=29 nf=29 protos=570 fproto_sim=NA
[peft] adapter saved to checkpoints/CIFAR-100-resnet34-top5-palm-cache6-ema0.999-b128-e5-lr0.001-wd1e-4-ltboth-bfmbalanced-fl0.2-lora_r8a32d0.05-temp0.08-stack/stage1
/home/shaokun/anaconda3/envs/PPALM/lib/python3.10/site-packages/torchvision/io/image.py:13: UserWarning: Failed to load image Python extension: '/home/shaokun/anaconda3/envs/PPALM/lib/python3.10/site-packages/torchvision/image.so: undefined symbol: _ZN3c1017RegisterOperatorsD1Ev'If you don't plan on using image functionality from `torchvision.io`, you can ignore this warning. Otherwise, there might be something wrong with your environment. Did you have `libjpeg` or `libpng` installed before building `torchvision` from source?
  warn(
Files already downloaded and verified
Files already downloaded and verified
ckpt loaded from checkpoints/CIFAR-100-resnet34-top5-palm-cache6-ema0.999-with-prototypes.pt
resnet34-top5-palm-cache6-ema0.999-b128-e5-lr0.001-wd1e-4-ltboth-bfmbalanced-fl0.2-lora_r8a32d0.05-temp0.08-stage1-inc1: Number of model parameters: 21843904
Processing in-distribution CIFAR-100 images
  0%|          | 0/391 [00:00<?, ?it/s]  0%|          | 1/391 [00:00<03:53,  1.67it/s]  2%|▏         | 6/391 [00:00<00:36, 10.46it/s]  3%|▎         | 11/391 [00:00<00:20, 18.21it/s]  4%|▍         | 16/391 [00:00<00:15, 24.66it/s]  5%|▌         | 20/391 [00:01<00:13, 28.18it/s]  6%|▋         | 25/391 [00:01<00:11, 33.10it/s]  8%|▊         | 30/391 [00:01<00:09, 36.59it/s]  9%|▉         | 35/391 [00:01<00:09, 38.46it/s] 10%|█         | 40/391 [00:01<00:08, 40.47it/s] 12%|█▏        | 45/391 [00:01<00:08, 41.64it/s] 13%|█▎        | 50/391 [00:01<00:07, 42.74it/s] 14%|█▍        | 55/391 [00:01<00:07, 43.52it/s] 15%|█▌        | 60/391 [00:01<00:08, 38.63it/s] 17%|█▋        | 65/391 [00:02<00:09, 35.58it/s] 18%|█▊        | 69/391 [00:02<00:09, 35.75it/s] 19%|█▊        | 73/391 [00:02<00:09, 35.03it/s] 20%|█▉        | 78/391 [00:02<00:08, 37.43it/s] 21%|██        | 83/391 [00:02<00:07, 39.41it/s] 23%|██▎       | 88/391 [00:02<00:07, 41.53it/s] 24%|██▍       | 93/391 [00:02<00:07, 41.39it/s] 25%|██▌       | 98/391 [00:02<00:06, 42.04it/s] 26%|██▋       | 103/391 [00:03<00:06, 42.76it/s] 28%|██▊       | 108/391 [00:03<00:06, 43.02it/s] 29%|██▉       | 113/391 [00:03<00:06, 43.73it/s] 30%|███       | 118/391 [00:03<00:06, 44.35it/s] 31%|███▏      | 123/391 [00:03<00:05, 44.67it/s] 33%|███▎      | 128/391 [00:03<00:05, 44.86it/s] 34%|███▍      | 133/391 [00:03<00:06, 40.21it/s] 35%|███▌      | 138/391 [00:03<00:06, 36.77it/s] 36%|███▋      | 142/391 [00:04<00:06, 35.85it/s] 37%|███▋      | 146/391 [00:04<00:07, 34.94it/s] 39%|███▉      | 152/391 [00:04<00:05, 40.05it/s] 40%|████      | 157/391 [00:04<00:05, 41.52it/s] 41%|████▏     | 162/391 [00:04<00:05, 42.47it/s] 43%|████▎     | 167/391 [00:04<00:05, 43.27it/s] 44%|████▍     | 173/391 [00:04<00:04, 44.37it/s] 46%|████▌     | 178/391 [00:04<00:04, 43.67it/s] 47%|████▋     | 183/391 [00:04<00:04, 42.81it/s] 48%|████▊     | 188/391 [00:05<00:04, 42.86it/s] 49%|████▉     | 193/391 [00:05<00:04, 43.31it/s] 51%|█████     | 198/391 [00:05<00:04, 43.10it/s] 52%|█████▏    | 203/391 [00:05<00:04, 40.21it/s] 53%|█████▎    | 208/391 [00:05<00:05, 36.44it/s] 54%|█████▍    | 212/391 [00:05<00:04, 36.02it/s] 55%|█████▌    | 216/391 [00:05<00:05, 34.39it/s] 57%|█████▋    | 221/391 [00:06<00:04, 36.37it/s] 58%|█████▊    | 226/391 [00:06<00:04, 38.85it/s] 59%|█████▉    | 231/391 [00:06<00:03, 40.42it/s] 60%|██████    | 236/391 [00:06<00:03, 41.63it/s] 62%|██████▏   | 241/391 [00:06<00:03, 42.55it/s] 63%|██████▎   | 246/391 [00:06<00:03, 42.81it/s] 64%|██████▍   | 252/391 [00:06<00:03, 44.98it/s] 66%|██████▌   | 257/391 [00:06<00:03, 43.91it/s] 67%|██████▋   | 262/391 [00:06<00:02, 43.96it/s] 68%|██████▊   | 267/391 [00:07<00:02, 44.10it/s] 70%|██████▉   | 272/391 [00:07<00:02, 43.92it/s] 71%|███████   | 277/391 [00:07<00:02, 39.42it/s] 72%|███████▏  | 282/391 [00:07<00:03, 35.98it/s] 73%|███████▎  | 286/391 [00:07<00:02, 35.26it/s] 74%|███████▍  | 290/391 [00:07<00:02, 35.09it/s] 75%|███████▌  | 295/391 [00:07<00:02, 37.67it/s] 77%|███████▋  | 300/391 [00:07<00:02, 39.11it/s] 78%|███████▊  | 305/391 [00:08<00:02, 39.68it/s] 79%|███████▉  | 310/391 [00:08<00:01, 41.82it/s] 81%|████████  | 315/391 [00:08<00:01, 42.60it/s] 82%|████████▏ | 320/391 [00:08<00:01, 42.67it/s] 83%|████████▎ | 325/391 [00:08<00:01, 42.71it/s] 84%|████████▍ | 330/391 [00:08<00:01, 43.23it/s] 86%|████████▌ | 335/391 [00:08<00:01, 43.89it/s] 87%|████████▋ | 340/391 [00:08<00:01, 42.89it/s] 88%|████████▊ | 345/391 [00:08<00:01, 43.31it/s] 90%|████████▉ | 350/391 [00:09<00:01, 38.57it/s] 91%|█████████ | 354/391 [00:09<00:01, 36.18it/s] 92%|█████████▏| 358/391 [00:09<00:00, 36.16it/s] 93%|█████████▎| 362/391 [00:09<00:00, 34.41it/s] 94%|█████████▍| 368/391 [00:09<00:00, 38.97it/s] 95%|█████████▌| 373/391 [00:09<00:00, 40.79it/s] 97%|█████████▋| 378/391 [00:09<00:00, 42.11it/s] 98%|█████████▊| 383/391 [00:09<00:00, 43.05it/s] 99%|█████████▉| 388/391 [00:10<00:00, 43.83it/s]100%|██████████| 391/391 [00:10<00:00, 38.52it/s]
50000 images processed, 10.294235944747925 seconds used

Processing in-distribution CIFAR-100 images
  0%|          | 0/79 [00:00<?, ?it/s]  1%|▏         | 1/79 [00:00<00:51,  1.52it/s]  8%|▊         | 6/79 [00:00<00:07,  9.95it/s] 14%|█▍        | 11/79 [00:00<00:03, 17.37it/s] 20%|██        | 16/79 [00:01<00:02, 23.32it/s] 27%|██▋       | 21/79 [00:01<00:02, 28.77it/s] 33%|███▎      | 26/79 [00:01<00:01, 32.33it/s] 39%|███▉      | 31/79 [00:01<00:01, 35.86it/s] 46%|████▌     | 36/79 [00:01<00:01, 38.48it/s] 53%|█████▎    | 42/79 [00:01<00:00, 42.36it/s] 59%|█████▉    | 47/79 [00:01<00:00, 41.85it/s] 66%|██████▌   | 52/79 [00:01<00:00, 37.76it/s] 72%|███████▏  | 57/79 [00:02<00:00, 36.17it/s] 77%|███████▋  | 61/79 [00:02<00:00, 35.56it/s] 82%|████████▏ | 65/79 [00:02<00:00, 35.84it/s] 89%|████████▊ | 70/79 [00:02<00:00, 38.48it/s] 95%|█████████▍| 75/79 [00:02<00:00, 40.45it/s]100%|██████████| 79/79 [00:02<00:00, 31.03it/s]
10000 images processed, 2.5663113594055176 seconds used

Saved forget OOD features to cache/resnet34-top5-palm-cache6-ema0.999-b128-e5-lr0.001-wd1e-4-ltboth-bfmbalanced-fl0.2-lora_r8a32d0.05-temp0.08-stage1-inc1/CIFAR-100/forget
Processing out-of-distribution SVHN images
  0%|          | 0/204 [00:00<?, ?it/s]  0%|          | 1/204 [00:00<02:04,  1.64it/s]  3%|▎         | 6/204 [00:00<00:19, 10.32it/s]  5%|▍         | 10/204 [00:00<00:11, 16.37it/s]  7%|▋         | 14/204 [00:00<00:08, 21.57it/s]  9%|▉         | 18/204 [00:01<00:07, 25.89it/s] 11%|█         | 22/204 [00:01<00:06, 28.15it/s] 13%|█▎        | 26/204 [00:01<00:06, 27.75it/s] 15%|█▍        | 30/204 [00:01<00:06, 28.46it/s] 17%|█▋        | 34/204 [00:01<00:06, 27.96it/s] 19%|█▉        | 39/204 [00:01<00:05, 31.53it/s] 21%|██        | 43/204 [00:01<00:04, 33.42it/s] 24%|██▎       | 48/204 [00:01<00:04, 35.30it/s] 25%|██▌       | 52/204 [00:02<00:04, 36.35it/s] 28%|██▊       | 57/204 [00:02<00:03, 37.57it/s] 30%|███       | 62/204 [00:02<00:03, 38.62it/s] 32%|███▏      | 66/204 [00:02<00:03, 38.30it/s] 35%|███▍      | 71/204 [00:02<00:03, 39.56it/s] 37%|███▋      | 75/204 [00:02<00:03, 39.47it/s] 39%|███▉      | 80/204 [00:02<00:03, 39.73it/s] 41%|████      | 84/204 [00:02<00:03, 36.70it/s] 43%|████▎     | 88/204 [00:03<00:03, 32.99it/s] 45%|████▌     | 92/204 [00:03<00:03, 32.63it/s] 47%|████▋     | 96/204 [00:03<00:03, 30.89it/s] 50%|████▉     | 101/204 [00:03<00:02, 34.47it/s] 52%|█████▏    | 106/204 [00:03<00:02, 36.37it/s] 54%|█████▍    | 111/204 [00:03<00:02, 37.57it/s] 56%|█████▋    | 115/204 [00:03<00:02, 37.98it/s] 59%|█████▉    | 120/204 [00:03<00:02, 38.90it/s] 61%|██████▏   | 125/204 [00:04<00:01, 39.69it/s] 64%|██████▎   | 130/204 [00:04<00:01, 39.88it/s] 66%|██████▌   | 135/204 [00:04<00:01, 40.24it/s] 69%|██████▊   | 140/204 [00:04<00:01, 39.74it/s] 71%|███████   | 144/204 [00:04<00:01, 39.38it/s] 73%|███████▎  | 148/204 [00:04<00:01, 35.59it/s] 75%|███████▍  | 152/204 [00:04<00:01, 34.19it/s] 76%|███████▋  | 156/204 [00:04<00:01, 34.92it/s] 78%|███████▊  | 160/204 [00:05<00:01, 31.98it/s] 80%|████████  | 164/204 [00:05<00:01, 33.81it/s] 83%|████████▎ | 169/204 [00:05<00:00, 35.62it/s] 85%|████████▌ | 174/204 [00:05<00:00, 36.99it/s] 88%|████████▊ | 179/204 [00:05<00:00, 38.54it/s] 90%|█████████ | 184/204 [00:05<00:00, 39.30it/s] 93%|█████████▎| 189/204 [00:05<00:00, 39.80it/s] 95%|█████████▌| 194/204 [00:05<00:00, 40.19it/s] 98%|█████████▊| 199/204 [00:05<00:00, 40.44it/s]100%|██████████| 204/204 [00:06<00:00, 42.41it/s]100%|██████████| 204/204 [00:06<00:00, 33.59it/s]
26032 images processed, 6.118778228759766 seconds used

Processing out-of-distribution places365 images
  0%|          | 0/79 [00:00<?, ?it/s]  1%|▏         | 1/79 [00:00<01:08,  1.14it/s]  8%|▊         | 6/79 [00:01<00:09,  7.68it/s] 13%|█▎        | 10/79 [00:01<00:05, 12.85it/s] 19%|█▉        | 15/79 [00:01<00:03, 19.05it/s] 25%|██▌       | 20/79 [00:01<00:02, 25.06it/s] 30%|███       | 24/79 [00:01<00:01, 27.97it/s] 35%|███▌      | 28/79 [00:01<00:01, 30.06it/s] 41%|████      | 32/79 [00:01<00:01, 29.05it/s] 46%|████▌     | 36/79 [00:01<00:01, 28.79it/s] 51%|█████     | 40/79 [00:01<00:01, 29.43it/s] 56%|█████▌    | 44/79 [00:02<00:01, 30.50it/s] 61%|██████    | 48/79 [00:02<00:00, 32.75it/s] 66%|██████▌   | 52/79 [00:02<00:00, 34.53it/s] 72%|███████▏  | 57/79 [00:02<00:00, 36.39it/s] 78%|███████▊  | 62/79 [00:02<00:00, 37.81it/s] 85%|████████▍ | 67/79 [00:02<00:00, 39.33it/s] 91%|█████████ | 72/79 [00:02<00:00, 41.79it/s] 97%|█████████▋| 77/79 [00:02<00:00, 41.55it/s]100%|██████████| 79/79 [00:02<00:00, 27.12it/s]
10000 images processed, 2.9609427452087402 seconds used

Processing out-of-distribution LSUN images
  0%|          | 0/79 [00:00<?, ?it/s]  1%|▏         | 1/79 [00:00<00:55,  1.40it/s]  6%|▋         | 5/79 [00:00<00:09,  7.56it/s] 13%|█▎        | 10/79 [00:00<00:04, 14.88it/s] 19%|█▉        | 15/79 [00:01<00:03, 21.10it/s] 25%|██▌       | 20/79 [00:01<00:02, 26.74it/s] 30%|███       | 24/79 [00:01<00:01, 27.67it/s] 35%|███▌      | 28/79 [00:01<00:01, 27.46it/s] 41%|████      | 32/79 [00:01<00:01, 29.18it/s] 46%|████▌     | 36/79 [00:01<00:01, 28.44it/s] 52%|█████▏    | 41/79 [00:01<00:01, 31.70it/s] 57%|█████▋    | 45/79 [00:01<00:01, 33.62it/s] 63%|██████▎   | 50/79 [00:02<00:00, 35.82it/s] 70%|██████▉   | 55/79 [00:02<00:00, 37.37it/s] 76%|███████▌  | 60/79 [00:02<00:00, 38.47it/s] 82%|████████▏ | 65/79 [00:02<00:00, 39.14it/s] 89%|████████▊ | 70/79 [00:02<00:00, 39.60it/s] 95%|█████████▍| 75/79 [00:02<00:00, 41.68it/s]100%|██████████| 79/79 [00:02<00:00, 28.61it/s]
10000 images processed, 2.783220052719116 seconds used

Processing out-of-distribution iSUN images
  0%|          | 0/70 [00:00<?, ?it/s]  1%|▏         | 1/70 [00:00<00:50,  1.36it/s]  9%|▊         | 6/70 [00:00<00:07,  8.96it/s] 16%|█▌        | 11/70 [00:00<00:03, 15.84it/s] 23%|██▎       | 16/70 [00:01<00:02, 21.76it/s] 29%|██▊       | 20/70 [00:01<00:02, 24.70it/s] 34%|███▍      | 24/70 [00:01<00:01, 25.39it/s] 40%|████      | 28/70 [00:01<00:01, 27.52it/s] 47%|████▋     | 33/70 [00:01<00:01, 31.43it/s] 53%|█████▎    | 37/70 [00:01<00:01, 30.24it/s] 60%|██████    | 42/70 [00:01<00:00, 33.24it/s] 67%|██████▋   | 47/70 [00:01<00:00, 35.52it/s] 74%|███████▍  | 52/70 [00:02<00:00, 37.08it/s] 81%|████████▏ | 57/70 [00:02<00:00, 38.22it/s] 89%|████████▊ | 62/70 [00:02<00:00, 40.38it/s] 96%|█████████▌| 67/70 [00:02<00:00, 40.58it/s]100%|██████████| 70/70 [00:02<00:00, 27.52it/s]
8925 images processed, 2.5873444080352783 seconds used

Processing out-of-distribution dtd images
  0%|          | 0/45 [00:00<?, ?it/s]  2%|▏         | 1/45 [00:01<00:57,  1.30s/it]  4%|▍         | 2/45 [00:01<00:25,  1.67it/s] 11%|█         | 5/45 [00:01<00:07,  5.15it/s] 22%|██▏       | 10/45 [00:01<00:03, 11.48it/s] 33%|███▎      | 15/45 [00:01<00:01, 17.46it/s] 42%|████▏     | 19/45 [00:01<00:01, 18.18it/s] 51%|█████     | 23/45 [00:02<00:01, 18.88it/s] 62%|██████▏   | 28/45 [00:02<00:00, 24.32it/s] 73%|███████▎  | 33/45 [00:02<00:00, 22.24it/s] 80%|████████  | 36/45 [00:02<00:00, 17.93it/s] 87%|████████▋ | 39/45 [00:02<00:00, 19.81it/s] 98%|█████████▊| 44/45 [00:03<00:00, 24.50it/s]100%|██████████| 45/45 [00:03<00:00, 14.83it/s]
5640 images processed, 3.0601978302001953 seconds used

32.137301445007324
/home/shaokun/anaconda3/envs/PPALM/lib/python3.10/site-packages/torchvision/io/image.py:13: UserWarning: Failed to load image Python extension: '/home/shaokun/anaconda3/envs/PPALM/lib/python3.10/site-packages/torchvision/image.so: undefined symbol: _ZN3c1017RegisterOperatorsD1Ev'If you don't plan on using image functionality from `torchvision.io`, you can ignore this warning. Otherwise, there might be something wrong with your environment. Did you have `libjpeg` or `libpng` installed before building `torchvision` from source?
  warn(
/home/shaokun/anaconda3/envs/PPALM/lib/python3.10/site-packages/umap/umap_.py:1952: UserWarning: n_jobs value 1 overridden to 1 by setting random_state. Use no seed for parallelism.
  warn(
/home/shaokun/anaconda3/envs/PPALM/lib/python3.10/site-packages/umap/umap_.py:1952: UserWarning: n_jobs value 1 overridden to 1 by setting random_state. Use no seed for parallelism.
  warn(
Evaluating SVHN
Evaluating places365
Evaluating LSUN
Evaluating iSUN
Evaluating dtd
 OOD detection method: SSD+
              FPR    AUROC  AUIN  
SVHN           2.55  99.36
places365     68.45  80.52
LSUN          22.01  94.99
iSUN          72.53  81.45
dtd           38.40  91.28
AVG           40.79  89.52
Retain-Acc: 0.7485
Forget-as-OOD (retain known vs forget novel):
  FPR: 55.20 AUROC: 88.46 AUIN: 99.25
22.109520435333252
[umap] saved to figs/umap_CIFAR-100_resnet34_top5-palm-cache6-ema0.999-b128-e5-lr0.001-wd1e-4-ltboth-bfmbalanced-fl0.2-lora_r8a32d0.05-temp0.08-stage1-inc1_domain.png
[umap] saved to figs/umap_CIFAR-100_resnet34_top5-palm-cache6-ema0.999-b128-e5-lr0.001-wd1e-4-ltboth-bfmbalanced-fl0.2-lora_r8a32d0.05-temp0.08-stage1-inc1_rf.png
/home/shaokun/anaconda3/envs/PPALM/lib/python3.10/site-packages/torchvision/io/image.py:13: UserWarning: Failed to load image Python extension: '/home/shaokun/anaconda3/envs/PPALM/lib/python3.10/site-packages/torchvision/image.so: undefined symbol: _ZN3c1017RegisterOperatorsD1Ev'If you don't plan on using image functionality from `torchvision.io`, you can ignore this warning. Otherwise, there might be something wrong with your environment. Did you have `libjpeg` or `libpng` installed before building `torchvision` from source?
  warn(
Files already downloaded and verified
Files already downloaded and verified
ckpt loaded from checkpoints/CIFAR-100-resnet34-top5-palm-cache6-ema0.999-with-prototypes.pt
resnet34-top5-palm-cache6-ema0.999-b128-e5-lr0.001-wd1e-4-ltboth-bfmbalanced-fl0.2-lora_r8a32d0.05-temp0.08-stage1-seen: Number of model parameters: 21843904
Processing in-distribution CIFAR-100 images
  0%|          | 0/391 [00:00<?, ?it/s]  0%|          | 1/391 [00:02<14:19,  2.20s/it]  2%|▏         | 6/391 [00:02<01:52,  3.44it/s]  3%|▎         | 11/391 [00:02<00:53,  7.08it/s]  4%|▍         | 16/391 [00:02<00:33, 11.33it/s]  5%|▌         | 21/391 [00:02<00:23, 15.93it/s]  7%|▋         | 26/391 [00:02<00:18, 20.17it/s]  8%|▊         | 31/391 [00:02<00:14, 24.12it/s]  9%|▉         | 36/391 [00:03<00:12, 28.47it/s] 10%|█         | 41/391 [00:03<00:10, 31.83it/s] 12%|█▏        | 46/391 [00:03<00:09, 34.74it/s] 13%|█▎        | 51/391 [00:03<00:09, 37.46it/s] 14%|█▍        | 56/391 [00:03<00:08, 39.13it/s] 16%|█▌        | 61/391 [00:03<00:08, 40.88it/s] 17%|█▋        | 66/391 [00:03<00:07, 41.94it/s] 18%|█▊        | 71/391 [00:03<00:07, 42.88it/s] 19%|█▉        | 76/391 [00:03<00:07, 42.62it/s] 21%|██        | 81/391 [00:04<00:07, 43.41it/s] 22%|██▏       | 86/391 [00:04<00:07, 43.43it/s] 23%|██▎       | 91/391 [00:04<00:07, 41.94it/s] 25%|██▍       | 96/391 [00:04<00:07, 37.78it/s] 26%|██▌       | 100/391 [00:04<00:07, 37.97it/s] 27%|██▋       | 104/391 [00:04<00:08, 35.67it/s] 28%|██▊       | 109/391 [00:04<00:07, 37.17it/s] 29%|██▉       | 114/391 [00:04<00:07, 39.32it/s] 30%|███       | 119/391 [00:05<00:06, 41.00it/s] 32%|███▏      | 124/391 [00:05<00:06, 42.42it/s] 33%|███▎      | 129/391 [00:05<00:06, 43.34it/s] 34%|███▍      | 134/391 [00:05<00:05, 43.91it/s] 36%|███▌      | 139/391 [00:05<00:05, 44.35it/s] 37%|███▋      | 144/391 [00:05<00:05, 44.63it/s] 38%|███▊      | 149/391 [00:05<00:05, 44.58it/s] 40%|███▉      | 155/391 [00:05<00:05, 46.49it/s] 41%|████      | 160/391 [00:05<00:05, 46.20it/s] 42%|████▏     | 165/391 [00:06<00:04, 45.56it/s] 43%|████▎     | 170/391 [00:06<00:05, 39.85it/s] 45%|████▍     | 175/391 [00:06<00:05, 36.38it/s] 46%|████▌     | 180/391 [00:06<00:05, 38.13it/s] 47%|████▋     | 184/391 [00:06<00:05, 36.07it/s] 48%|████▊     | 189/391 [00:06<00:05, 37.38it/s] 50%|████▉     | 194/391 [00:06<00:05, 38.88it/s] 51%|█████     | 199/391 [00:06<00:04, 40.66it/s] 52%|█████▏    | 204/391 [00:07<00:04, 41.76it/s] 53%|█████▎    | 209/391 [00:07<00:04, 42.83it/s] 55%|█████▍    | 215/391 [00:07<00:03, 45.48it/s] 56%|█████▋    | 220/391 [00:07<00:03, 45.49it/s] 58%|█████▊    | 225/391 [00:07<00:03, 45.44it/s] 59%|█████▉    | 230/391 [00:07<00:03, 45.44it/s] 60%|██████    | 235/391 [00:07<00:03, 44.86it/s] 61%|██████▏   | 240/391 [00:07<00:03, 45.01it/s] 63%|██████▎   | 245/391 [00:07<00:03, 45.10it/s] 64%|██████▍   | 250/391 [00:08<00:03, 39.23it/s] 65%|██████▌   | 255/391 [00:08<00:03, 36.35it/s] 66%|██████▌   | 259/391 [00:08<00:03, 35.23it/s] 67%|██████▋   | 263/391 [00:08<00:03, 35.56it/s] 69%|██████▊   | 268/391 [00:08<00:03, 37.77it/s] 70%|██████▉   | 273/391 [00:08<00:03, 39.20it/s] 71%|███████   | 278/391 [00:08<00:02, 41.43it/s] 72%|███████▏  | 283/391 [00:08<00:02, 42.61it/s] 74%|███████▎  | 288/391 [00:09<00:02, 42.85it/s] 75%|███████▍  | 293/391 [00:09<00:02, 43.60it/s] 76%|███████▌  | 298/391 [00:09<00:02, 43.83it/s] 77%|███████▋  | 303/391 [00:09<00:01, 44.00it/s] 79%|███████▉  | 308/391 [00:09<00:01, 44.20it/s] 80%|████████  | 313/391 [00:09<00:01, 44.57it/s] 81%|████████▏ | 318/391 [00:09<00:01, 44.54it/s] 83%|████████▎ | 323/391 [00:09<00:01, 40.42it/s] 84%|████████▍ | 328/391 [00:10<00:01, 36.90it/s] 85%|████████▍ | 332/391 [00:10<00:01, 36.14it/s] 86%|████████▌ | 336/391 [00:10<00:01, 34.96it/s] 87%|████████▋ | 341/391 [00:10<00:01, 38.48it/s] 88%|████████▊ | 346/391 [00:10<00:01, 39.72it/s] 90%|████████▉ | 351/391 [00:10<00:00, 40.82it/s] 91%|█████████ | 356/391 [00:10<00:00, 41.87it/s] 92%|█████████▏| 361/391 [00:10<00:00, 42.62it/s] 94%|█████████▎| 366/391 [00:10<00:00, 43.45it/s] 95%|█████████▍| 371/391 [00:11<00:00, 44.14it/s] 96%|█████████▌| 376/391 [00:11<00:00, 44.50it/s] 97%|█████████▋| 381/391 [00:11<00:00, 44.79it/s] 99%|█████████▊| 386/391 [00:11<00:00, 44.98it/s]100%|██████████| 391/391 [00:11<00:00, 43.97it/s]100%|██████████| 391/391 [00:11<00:00, 33.92it/s]
50000 images processed, 11.683382987976074 seconds used

Processing in-distribution CIFAR-100 images
  0%|          | 0/79 [00:00<?, ?it/s]  1%|▏         | 1/79 [00:00<00:50,  1.55it/s]  8%|▊         | 6/79 [00:00<00:07, 10.08it/s] 14%|█▍        | 11/79 [00:00<00:03, 17.76it/s] 20%|██        | 16/79 [00:00<00:02, 24.83it/s] 27%|██▋       | 21/79 [00:01<00:01, 30.16it/s] 33%|███▎      | 26/79 [00:01<00:01, 32.20it/s] 39%|███▉      | 31/79 [00:01<00:01, 31.68it/s] 44%|████▍     | 35/79 [00:01<00:01, 31.71it/s] 49%|████▉     | 39/79 [00:01<00:01, 31.24it/s] 54%|█████▍    | 43/79 [00:01<00:01, 33.14it/s] 61%|██████    | 48/79 [00:01<00:00, 36.29it/s] 67%|██████▋   | 53/79 [00:01<00:00, 38.82it/s] 73%|███████▎  | 58/79 [00:02<00:00, 40.71it/s] 80%|███████▉  | 63/79 [00:02<00:00, 42.07it/s] 86%|████████▌ | 68/79 [00:02<00:00, 43.64it/s] 92%|█████████▏| 73/79 [00:02<00:00, 44.00it/s] 99%|█████████▊| 78/79 [00:02<00:00, 44.43it/s]100%|██████████| 79/79 [00:03<00:00, 20.94it/s]
10000 images processed, 3.7944095134735107 seconds used

Saved forget OOD features to cache/resnet34-top5-palm-cache6-ema0.999-b128-e5-lr0.001-wd1e-4-ltboth-bfmbalanced-fl0.2-lora_r8a32d0.05-temp0.08-stage1-seen/CIFAR-100/forget
Processing out-of-distribution SVHN images
  0%|          | 0/204 [00:00<?, ?it/s]  0%|          | 1/204 [00:00<02:29,  1.35it/s]  2%|▏         | 4/204 [00:00<00:33,  5.91it/s]  4%|▍         | 8/204 [00:00<00:16, 11.95it/s]  6%|▋         | 13/204 [00:01<00:10, 18.92it/s]  9%|▉         | 18/204 [00:01<00:07, 24.54it/s] 11%|█▏        | 23/204 [00:01<00:06, 29.03it/s] 14%|█▎        | 28/204 [00:01<00:05, 32.19it/s] 16%|█▌        | 33/204 [00:01<00:04, 34.68it/s] 18%|█▊        | 37/204 [00:01<00:04, 35.61it/s] 21%|██        | 42/204 [00:01<00:04, 36.84it/s] 23%|██▎       | 47/204 [00:01<00:04, 37.65it/s] 25%|██▌       | 52/204 [00:02<00:03, 39.73it/s] 28%|██▊       | 57/204 [00:02<00:03, 37.53it/s] 30%|██▉       | 61/204 [00:02<00:04, 33.74it/s] 32%|███▏      | 65/204 [00:02<00:04, 33.33it/s] 34%|███▍      | 69/204 [00:02<00:04, 31.64it/s] 36%|███▌      | 73/204 [00:02<00:03, 33.20it/s] 38%|███▊      | 78/204 [00:02<00:03, 35.54it/s] 41%|████      | 83/204 [00:02<00:03, 37.18it/s] 43%|████▎     | 87/204 [00:03<00:03, 37.25it/s] 45%|████▌     | 92/204 [00:03<00:02, 38.17it/s] 47%|████▋     | 96/204 [00:03<00:02, 38.43it/s] 50%|████▉     | 101/204 [00:03<00:02, 40.68it/s] 52%|█████▏    | 106/204 [00:03<00:02, 40.79it/s] 54%|█████▍    | 111/204 [00:03<00:02, 40.38it/s] 57%|█████▋    | 116/204 [00:03<00:02, 39.97it/s] 59%|█████▉    | 121/204 [00:03<00:02, 36.79it/s] 61%|██████▏   | 125/204 [00:04<00:02, 33.61it/s] 63%|██████▎   | 129/204 [00:04<00:02, 33.08it/s] 65%|██████▌   | 133/204 [00:04<00:02, 32.79it/s] 68%|██████▊   | 138/204 [00:04<00:01, 35.11it/s] 70%|███████   | 143/204 [00:04<00:01, 36.82it/s] 73%|███████▎  | 148/204 [00:04<00:01, 37.83it/s] 75%|███████▌  | 153/204 [00:04<00:01, 38.77it/s] 77%|███████▋  | 158/204 [00:04<00:01, 39.07it/s] 80%|███████▉  | 163/204 [00:05<00:01, 39.66it/s] 82%|████████▏ | 167/204 [00:05<00:00, 39.55it/s] 84%|████████▍ | 172/204 [00:05<00:00, 39.96it/s] 87%|████████▋ | 177/204 [00:05<00:00, 40.29it/s] 89%|████████▉ | 182/204 [00:05<00:00, 40.48it/s] 92%|█████████▏| 187/204 [00:05<00:00, 38.86it/s] 94%|█████████▎| 191/204 [00:05<00:00, 34.91it/s] 96%|█████████▌| 195/204 [00:05<00:00, 34.32it/s] 98%|█████████▊| 199/204 [00:06<00:00, 32.97it/s]100%|██████████| 204/204 [00:06<00:00, 35.96it/s]100%|██████████| 204/204 [00:06<00:00, 32.91it/s]
26032 images processed, 6.252152442932129 seconds used

Processing out-of-distribution places365 images
  0%|          | 0/79 [00:00<?, ?it/s]  1%|▏         | 1/79 [00:00<01:07,  1.16it/s]  5%|▌         | 4/79 [00:00<00:14,  5.23it/s] 11%|█▏        | 9/79 [00:01<00:05, 12.13it/s] 16%|█▋        | 13/79 [00:01<00:03, 16.76it/s] 23%|██▎       | 18/79 [00:01<00:02, 22.46it/s] 29%|██▉       | 23/79 [00:01<00:02, 26.90it/s] 35%|███▌      | 28/79 [00:01<00:01, 30.61it/s] 42%|████▏     | 33/79 [00:01<00:01, 33.37it/s] 48%|████▊     | 38/79 [00:01<00:01, 35.33it/s] 54%|█████▍    | 43/79 [00:01<00:00, 36.73it/s] 59%|█████▉    | 47/79 [00:02<00:00, 37.33it/s] 66%|██████▌   | 52/79 [00:02<00:00, 38.46it/s] 72%|███████▏  | 57/79 [00:02<00:00, 39.24it/s] 78%|███████▊  | 62/79 [00:02<00:00, 39.80it/s] 85%|████████▍ | 67/79 [00:02<00:00, 34.74it/s] 90%|████████▉ | 71/79 [00:02<00:00, 33.88it/s] 95%|█████████▍| 75/79 [00:02<00:00, 31.94it/s]100%|██████████| 79/79 [00:02<00:00, 26.68it/s]
10000 images processed, 2.9946441650390625 seconds used

Processing out-of-distribution LSUN images
  0%|          | 0/79 [00:00<?, ?it/s]  1%|▏         | 1/79 [00:00<00:53,  1.47it/s]  5%|▌         | 4/79 [00:00<00:11,  6.35it/s] 10%|█         | 8/79 [00:00<00:05, 12.49it/s] 16%|█▋        | 13/79 [00:01<00:03, 19.39it/s] 23%|██▎       | 18/79 [00:01<00:02, 24.88it/s] 29%|██▉       | 23/79 [00:01<00:01, 29.24it/s] 35%|███▌      | 28/79 [00:01<00:01, 32.51it/s] 42%|████▏     | 33/79 [00:01<00:01, 36.42it/s] 48%|████▊     | 38/79 [00:01<00:01, 37.14it/s] 54%|█████▍    | 43/79 [00:01<00:00, 38.05it/s] 61%|██████    | 48/79 [00:01<00:00, 38.73it/s] 67%|██████▋   | 53/79 [00:02<00:00, 39.38it/s] 73%|███████▎  | 58/79 [00:02<00:00, 37.11it/s] 78%|███████▊  | 62/79 [00:02<00:00, 33.83it/s] 84%|████████▎ | 66/79 [00:02<00:00, 33.04it/s] 89%|████████▊ | 70/79 [00:02<00:00, 31.53it/s] 95%|█████████▍| 75/79 [00:02<00:00, 34.14it/s]100%|██████████| 79/79 [00:02<00:00, 28.44it/s]
10000 images processed, 2.802116632461548 seconds used

Processing out-of-distribution iSUN images
  0%|          | 0/70 [00:00<?, ?it/s]  1%|▏         | 1/70 [00:00<00:50,  1.37it/s]  7%|▋         | 5/70 [00:00<00:08,  7.57it/s] 14%|█▍        | 10/70 [00:00<00:04, 14.93it/s] 21%|██▏       | 15/70 [00:01<00:02, 21.16it/s] 29%|██▊       | 20/70 [00:01<00:01, 26.21it/s] 36%|███▌      | 25/70 [00:01<00:01, 29.99it/s] 43%|████▎     | 30/70 [00:01<00:01, 32.86it/s] 50%|█████     | 35/70 [00:01<00:00, 35.27it/s] 57%|█████▋    | 40/70 [00:01<00:00, 36.71it/s] 64%|██████▍   | 45/70 [00:01<00:00, 37.96it/s] 71%|███████▏  | 50/70 [00:01<00:00, 38.85it/s] 79%|███████▊  | 55/70 [00:02<00:00, 36.65it/s] 84%|████████▍ | 59/70 [00:02<00:00, 35.54it/s] 90%|█████████ | 63/70 [00:02<00:00, 34.77it/s] 96%|█████████▌| 67/70 [00:02<00:00, 33.33it/s]100%|██████████| 70/70 [00:02<00:00, 27.32it/s]
8925 images processed, 2.5964019298553467 seconds used

Processing out-of-distribution dtd images
  0%|          | 0/45 [00:00<?, ?it/s]  2%|▏         | 1/45 [00:01<00:53,  1.23s/it]  4%|▍         | 2/45 [00:01<00:24,  1.76it/s] 13%|█▎        | 6/45 [00:01<00:05,  6.67it/s] 24%|██▍       | 11/45 [00:01<00:02, 12.91it/s] 38%|███▊      | 17/45 [00:01<00:01, 15.96it/s] 44%|████▍     | 20/45 [00:01<00:01, 17.29it/s] 51%|█████     | 23/45 [00:02<00:01, 19.30it/s] 60%|██████    | 27/45 [00:02<00:00, 22.09it/s] 69%|██████▉   | 31/45 [00:02<00:00, 25.14it/s] 76%|███████▌  | 34/45 [00:02<00:00, 17.04it/s] 87%|████████▋ | 39/45 [00:02<00:00, 22.62it/s] 98%|█████████▊| 44/45 [00:02<00:00, 26.88it/s]100%|██████████| 45/45 [00:02<00:00, 15.41it/s]
5640 images processed, 2.943917751312256 seconds used

34.78594636917114
/home/shaokun/anaconda3/envs/PPALM/lib/python3.10/site-packages/torchvision/io/image.py:13: UserWarning: Failed to load image Python extension: '/home/shaokun/anaconda3/envs/PPALM/lib/python3.10/site-packages/torchvision/image.so: undefined symbol: _ZN3c1017RegisterOperatorsD1Ev'If you don't plan on using image functionality from `torchvision.io`, you can ignore this warning. Otherwise, there might be something wrong with your environment. Did you have `libjpeg` or `libpng` installed before building `torchvision` from source?
  warn(
/home/shaokun/anaconda3/envs/PPALM/lib/python3.10/site-packages/umap/umap_.py:1952: UserWarning: n_jobs value 1 overridden to 1 by setting random_state. Use no seed for parallelism.
  warn(
/home/shaokun/anaconda3/envs/PPALM/lib/python3.10/site-packages/umap/umap_.py:1952: UserWarning: n_jobs value 1 overridden to 1 by setting random_state. Use no seed for parallelism.
  warn(
Evaluating SVHN
Evaluating places365
Evaluating LSUN
Evaluating iSUN
Evaluating dtd
 OOD detection method: SSD+
              FPR    AUROC  AUIN  
SVHN           2.55  99.36
places365     68.45  80.52
LSUN          22.01  94.99
iSUN          72.53  81.45
dtd           38.40  91.28
AVG           40.79  89.52
Retain-Acc: 0.7485
Forget-as-OOD (retain known vs forget novel):
  FPR: 55.20 AUROC: 88.46 AUIN: 99.25
17.20573902130127
[umap] saved to figs/umap_CIFAR-100_resnet34_top5-palm-cache6-ema0.999-b128-e5-lr0.001-wd1e-4-ltboth-bfmbalanced-fl0.2-lora_r8a32d0.05-temp0.08-stage1-seen_domain.png
[umap] saved to figs/umap_CIFAR-100_resnet34_top5-palm-cache6-ema0.999-b128-e5-lr0.001-wd1e-4-ltboth-bfmbalanced-fl0.2-lora_r8a32d0.05-temp0.08-stage1-seen_rf.png
==== Stage 2: forget_inc={66,67,88,94,57}; forget_seen={0,8,11,40,51}; all={0,8,11,40,51,66,67,88,94,57} ====
/home/shaokun/anaconda3/envs/PPALM/lib/python3.10/site-packages/torchvision/io/image.py:13: UserWarning: Failed to load image Python extension: '/home/shaokun/anaconda3/envs/PPALM/lib/python3.10/site-packages/torchvision/image.so: undefined symbol: _ZN3c1017RegisterOperatorsD1Ev'If you don't plan on using image functionality from `torchvision.io`, you can ignore this warning. Otherwise, there might be something wrong with your environment. Did you have `libjpeg` or `libpng` installed before building `torchvision` from source?
  warn(
/home/shaokun/PALM/main.py:54: FutureWarning: `torch.cuda.amp.GradScaler(args...)` is deprecated. Please use `torch.amp.GradScaler('cuda', args...)` instead.
  scaler = torch.cuda.amp.GradScaler()
Namespace(in_dataset='CIFAR-100', out_datasets=['inat', 'sun50', 'places50', 'dtd'], backbone='resnet34', method='top5-palm-cache6-ema0.999', seed=1, gpu='0', epochs=5, batch_size=128, lr=0.001, weight_decay=0.0001, print_every=50, fine_tune=False, temp=0.08, cosine=True, warm=False, lr_decay_epochs='700,800,900', lr_decay_rate=0.1, layers=100, depth=40, width=4, growth=12, droprate=0.0, save_path='CIFAR-10-ResNet18.pt', load_path='checkpoints/CIFAR-100-resnet34-top5-palm-cache6-ema0.999-with-prototypes.pt', reduce=0.5, score='mahalanobis', threshold=1.0, k=5, momentum=0.9, proto_m=0.999, cache_size=6, nviews=2, lambda_pcon=1.0, epsilon=0.05, incremental=False, use_lora=True, lora_impl='peft', lora_r=8, lora_alpha=32, lora_dropout=0.05, lora_target='both', adapter_save_path='checkpoints/CIFAR-100-resnet34-top5-palm-cache6-ema0.999-b128-e5-lr0.001-wd1e-4-ltboth-bfmbalanced-fl0.2-lora_r8a32d0.05-temp0.08-stack/stage2', adapter_load_path='checkpoints/CIFAR-100-resnet34-top5-palm-cache6-ema0.999-b128-e5-lr0.001-wd1e-4-ltboth-bfmbalanced-fl0.2-lora_r8a32d0.05-temp0.08-stack/stage1', adapter_load_paths=None, lora_new_adapter_name=None, lora_stack=False, lora_orth_enable=True, lora_orth_lambda=0.1, lora_orth_ref_paths='checkpoints/CIFAR-100-resnet34-top5-palm-cache6-ema0.999-b128-e5-lr0.001-wd1e-4-ltboth-bfmbalanced-fl0.2-lora_r8a32d0.05-temp0.08-stack/stage1', forget_classes='0,8,11,40,51,66,67,88,94,57', forget_list_path=None, forget_classes_inc='66,67,88,94,57', forget_classes_seen='0,8,11,40,51', retain_exclude_csv=None, forget_csv=None, forget_lambda=0.2, forget_margin=100.0, forget_strategy='proto', centers_path=None, precision_path=None, batch_forget_mode='balanced', forget_proto_enable=False, forget_attr_w=1.0, forget_proto_rep_w=1.0, forget_avgproto_enable=False, forget_avgproto_w=1.0, umap_enable=False, umap_by='domain', umap_max_points=20000, umap_neighbors=15, umap_min_dist=0.05, umap_metric='cosine', umap_save_path=None, umap_rf_only=False, keep_cache=False, argument=True)
Files already downloaded and verified
ckpt loaded from checkpoints/CIFAR-100-resnet34-top5-palm-cache6-ema0.999-with-prototypes.pt
[peft] adapter loaded from checkpoints/CIFAR-100-resnet34-top5-palm-cache6-ema0.999-b128-e5-lr0.001-wd1e-4-ltboth-bfmbalanced-fl0.2-lora_r8a32d0.05-temp0.08-stack/stage1
[peft] active adapters set to: default
resnet34-top5-palm-cache6-ema0.999: Number of model parameters: 21843904
[debug] trainable_count = 16
[debug] trainable: base_model.model.encoder.layer4.0.conv1.lora_A.default.weight
[debug] trainable: base_model.model.encoder.layer4.0.conv1.lora_B.default.weight
[debug] trainable: base_model.model.encoder.layer4.0.conv2.lora_A.default.weight
[debug] trainable: base_model.model.encoder.layer4.0.conv2.lora_B.default.weight
[debug] trainable: base_model.model.encoder.layer4.0.shortcut.0.lora_A.default.weight
[debug] trainable: base_model.model.encoder.layer4.0.shortcut.0.lora_B.default.weight
[debug] trainable: base_model.model.encoder.layer4.1.conv1.lora_A.default.weight
[debug] trainable: base_model.model.encoder.layer4.1.conv1.lora_B.default.weight
[debug] trainable: base_model.model.encoder.layer4.1.conv2.lora_A.default.weight
[debug] trainable: base_model.model.encoder.layer4.1.conv2.lora_B.default.weight
[debug] trainable: base_model.model.encoder.layer4.2.conv1.lora_A.default.weight
[debug] trainable: base_model.model.encoder.layer4.2.conv1.lora_B.default.weight
[debug] trainable: base_model.model.encoder.layer4.2.conv2.lora_A.default.weight
[debug] trainable: base_model.model.encoder.layer4.2.conv2.lora_B.default.weight
[debug] trainable: base_model.model.head.2.lora_A.default.weight
[debug] trainable: base_model.model.head.2.lora_B.default.weight
[debug][warn] non-LoRA trainables detected: ['base_model.model.encoder.layer4.0.conv1.lora_A.default.weight', 'base_model.model.encoder.layer4.0.conv1.lora_B.default.weight', 'base_model.model.encoder.layer4.0.conv2.lora_A.default.weight', 'base_model.model.encoder.layer4.0.conv2.lora_B.default.weight', 'base_model.model.encoder.layer4.0.shortcut.0.lora_A.default.weight', 'base_model.model.encoder.layer4.0.shortcut.0.lora_B.default.weight', 'base_model.model.encoder.layer4.1.conv1.lora_A.default.weight', 'base_model.model.encoder.layer4.1.conv1.lora_B.default.weight', 'base_model.model.encoder.layer4.1.conv2.lora_A.default.weight', 'base_model.model.encoder.layer4.1.conv2.lora_B.default.weight']
  0%|          | 0/5 [00:00<?, ?it/s]/home/shaokun/PALM/trainer.py:139: FutureWarning: `torch.cuda.amp.autocast(args...)` is deprecated. Please use `torch.amp.autocast('cuda', args...)` instead.
  with torch.cuda.amp.autocast():
/home/shaokun/PALM/trainer.py:226: FutureWarning: `torch.cuda.amp.autocast(args...)` is deprecated. Please use `torch.amp.autocast('cuda', args...)` instead.
  with torch.cuda.amp.autocast(enabled=False):
 20%|██        | 1/5 [05:49<23:19, 349.89s/it] 40%|████      | 2/5 [09:40<13:58, 279.61s/it] 60%|██████    | 3/5 [13:25<08:29, 254.83s/it] 80%|████████  | 4/5 [17:16<04:05, 245.22s/it]100%|██████████| 5/5 [21:03<00:00, 238.96s/it]100%|██████████| 5/5 [21:03<00:00, 252.80s/it]
[loss] ep 0 it 0 total=17051764.0000 mle=1.8552 pcon=5.2951 forget=1.4192 favg=0.0000 nr=36 nf=36 protos=540 fproto_sim=NA
[loss] ep 0 it 50 total=17040698.0000 mle=1.7834 pcon=5.2896 forget=1.4363 favg=0.0000 nr=34 nf=34 protos=540 fproto_sim=NA
[loss] ep 0 it 100 total=16954438.0000 mle=1.9396 pcon=5.2844 forget=1.4266 favg=0.0000 nr=34 nf=34 protos=540 fproto_sim=NA
[loss] ep 0 it 150 total=16849948.0000 mle=2.0336 pcon=5.2790 forget=1.4835 favg=0.0000 nr=32 nf=32 protos=540 fproto_sim=NA
[loss] ep 0 it 200 total=16761834.0000 mle=2.1747 pcon=5.2732 forget=1.4667 favg=0.0000 nr=34 nf=34 protos=540 fproto_sim=NA
[loss] ep 0 it 250 total=16703603.0000 mle=1.9322 pcon=5.2675 forget=1.3636 favg=0.0000 nr=30 nf=30 protos=540 fproto_sim=NA
[loss] ep 0 it 300 total=16669944.0000 mle=2.0254 pcon=5.2620 forget=1.3865 favg=0.0000 nr=34 nf=34 protos=540 fproto_sim=NA
[loss] ep 0 it 350 total=16651235.0000 mle=2.0654 pcon=5.2564 forget=1.3820 favg=0.0000 nr=30 nf=30 protos=540 fproto_sim=NA
[peft] adapter saved to checkpoints/CIFAR-100-resnet34-top5-palm-cache6-ema0.999-b128-e5-lr0.001-wd1e-4-ltboth-bfmbalanced-fl0.2-lora_r8a32d0.05-temp0.08-stack/stage2
[loss] ep 1 it 10 total=16640656.0000 mle=2.4055 pcon=5.2505 forget=1.4502 favg=0.0000 nr=23 nf=23 protos=540 fproto_sim=NA
[loss] ep 1 it 60 total=16633941.0000 mle=1.8921 pcon=5.2445 forget=1.3628 favg=0.0000 nr=38 nf=38 protos=540 fproto_sim=NA
[loss] ep 1 it 110 total=16629395.0000 mle=1.9954 pcon=5.2388 forget=1.3977 favg=0.0000 nr=34 nf=34 protos=540 fproto_sim=NA
[loss] ep 1 it 160 total=16626047.0000 mle=2.1041 pcon=5.2332 forget=1.3747 favg=0.0000 nr=32 nf=32 protos=540 fproto_sim=NA
[loss] ep 1 it 210 total=16623403.0000 mle=2.1859 pcon=5.2278 forget=1.3656 favg=0.0000 nr=32 nf=32 protos=540 fproto_sim=NA
[loss] ep 1 it 260 total=16621179.0000 mle=1.9677 pcon=5.2225 forget=1.3573 favg=0.0000 nr=34 nf=34 protos=540 fproto_sim=NA
[loss] ep 1 it 310 total=16619304.0000 mle=2.2898 pcon=5.2176 forget=1.4054 favg=0.0000 nr=28 nf=28 protos=540 fproto_sim=NA
[loss] ep 1 it 360 total=16617620.0000 mle=2.7199 pcon=5.2136 forget=1.4390 favg=0.0000 nr=31 nf=31 protos=540 fproto_sim=NA
[peft] adapter saved to checkpoints/CIFAR-100-resnet34-top5-palm-cache6-ema0.999-b128-e5-lr0.001-wd1e-4-ltboth-bfmbalanced-fl0.2-lora_r8a32d0.05-temp0.08-stack/stage2
[loss] ep 2 it 20 total=16616139.0000 mle=2.6419 pcon=5.2096 forget=1.3846 favg=0.0000 nr=26 nf=26 protos=540 fproto_sim=NA
[loss] ep 2 it 70 total=16614835.0000 mle=2.6214 pcon=5.2056 forget=1.3632 favg=0.0000 nr=32 nf=32 protos=540 fproto_sim=NA
[loss] ep 2 it 120 total=16613658.0000 mle=3.6499 pcon=5.2015 forget=1.4289 favg=0.0000 nr=24 nf=24 protos=540 fproto_sim=NA
[loss] ep 2 it 170 total=16612608.0000 mle=2.6698 pcon=5.1983 forget=1.3972 favg=0.0000 nr=40 nf=40 protos=540 fproto_sim=NA
[loss] ep 2 it 220 total=16611676.0000 mle=3.8136 pcon=5.1951 forget=1.4923 favg=0.0000 nr=37 nf=37 protos=540 fproto_sim=NA
[loss] ep 2 it 270 total=16610854.0000 mle=4.3987 pcon=5.1933 forget=1.4623 favg=0.0000 nr=29 nf=29 protos=540 fproto_sim=NA
[loss] ep 2 it 320 total=16610129.0000 mle=4.0284 pcon=5.1912 forget=1.4287 favg=0.0000 nr=31 nf=31 protos=540 fproto_sim=NA
[loss] ep 2 it 370 total=16609489.0000 mle=3.4372 pcon=5.1891 forget=1.4780 favg=0.0000 nr=35 nf=35 protos=540 fproto_sim=NA
[peft] adapter saved to checkpoints/CIFAR-100-resnet34-top5-palm-cache6-ema0.999-b128-e5-lr0.001-wd1e-4-ltboth-bfmbalanced-fl0.2-lora_r8a32d0.05-temp0.08-stack/stage2
[loss] ep 3 it 30 total=16608938.0000 mle=3.5988 pcon=5.1874 forget=1.4650 favg=0.0000 nr=36 nf=36 protos=540 fproto_sim=NA
[loss] ep 3 it 80 total=16608447.0000 mle=3.8167 pcon=5.1853 forget=1.4602 favg=0.0000 nr=30 nf=30 protos=540 fproto_sim=NA
[loss] ep 3 it 130 total=16608025.0000 mle=3.8468 pcon=5.1837 forget=1.4192 favg=0.0000 nr=34 nf=34 protos=540 fproto_sim=NA
[loss] ep 3 it 180 total=16607660.0000 mle=4.9282 pcon=5.1822 forget=1.5327 favg=0.0000 nr=23 nf=23 protos=540 fproto_sim=NA
[loss] ep 3 it 230 total=16607343.0000 mle=4.1197 pcon=5.1810 forget=1.4973 favg=0.0000 nr=32 nf=32 protos=540 fproto_sim=NA
[loss] ep 3 it 280 total=16607071.0000 mle=4.2575 pcon=5.1797 forget=1.4369 favg=0.0000 nr=31 nf=31 protos=540 fproto_sim=NA
[loss] ep 3 it 330 total=16606843.0000 mle=3.5143 pcon=5.1783 forget=1.5047 favg=0.0000 nr=39 nf=39 protos=540 fproto_sim=NA
[loss] ep 3 it 380 total=16606647.0000 mle=3.7428 pcon=5.1767 forget=1.4799 favg=0.0000 nr=35 nf=35 protos=540 fproto_sim=NA
[peft] adapter saved to checkpoints/CIFAR-100-resnet34-top5-palm-cache6-ema0.999-b128-e5-lr0.001-wd1e-4-ltboth-bfmbalanced-fl0.2-lora_r8a32d0.05-temp0.08-stack/stage2
[loss] ep 4 it 40 total=16606473.0000 mle=4.0311 pcon=5.1755 forget=1.4753 favg=0.0000 nr=30 nf=30 protos=540 fproto_sim=NA
[loss] ep 4 it 90 total=16606335.0000 mle=4.7270 pcon=5.1743 forget=1.5069 favg=0.0000 nr=23 nf=23 protos=540 fproto_sim=NA
[loss] ep 4 it 140 total=16606202.0000 mle=4.3058 pcon=5.1732 forget=1.5708 favg=0.0000 nr=31 nf=31 protos=540 fproto_sim=NA
[loss] ep 4 it 190 total=16606102.0000 mle=4.3258 pcon=5.1725 forget=1.5744 favg=0.0000 nr=39 nf=39 protos=540 fproto_sim=NA
[loss] ep 4 it 240 total=16606004.0000 mle=4.2328 pcon=5.1717 forget=1.4833 favg=0.0000 nr=36 nf=36 protos=540 fproto_sim=NA
[loss] ep 4 it 290 total=16605923.0000 mle=4.7272 pcon=5.1711 forget=1.5383 favg=0.0000 nr=35 nf=35 protos=540 fproto_sim=NA
[loss] ep 4 it 340 total=16605855.0000 mle=4.6125 pcon=5.1706 forget=1.5200 favg=0.0000 nr=35 nf=35 protos=540 fproto_sim=NA
[peft] adapter saved to checkpoints/CIFAR-100-resnet34-top5-palm-cache6-ema0.999-b128-e5-lr0.001-wd1e-4-ltboth-bfmbalanced-fl0.2-lora_r8a32d0.05-temp0.08-stack/stage2
/home/shaokun/anaconda3/envs/PPALM/lib/python3.10/site-packages/torchvision/io/image.py:13: UserWarning: Failed to load image Python extension: '/home/shaokun/anaconda3/envs/PPALM/lib/python3.10/site-packages/torchvision/image.so: undefined symbol: _ZN3c1017RegisterOperatorsD1Ev'If you don't plan on using image functionality from `torchvision.io`, you can ignore this warning. Otherwise, there might be something wrong with your environment. Did you have `libjpeg` or `libpng` installed before building `torchvision` from source?
  warn(
Files already downloaded and verified
Files already downloaded and verified
ckpt loaded from checkpoints/CIFAR-100-resnet34-top5-palm-cache6-ema0.999-with-prototypes.pt
resnet34-top5-palm-cache6-ema0.999-b128-e5-lr0.001-wd1e-4-ltboth-bfmbalanced-fl0.2-lora_r8a32d0.05-temp0.08-stage2-inc1: Number of model parameters: 21843904
Processing in-distribution CIFAR-100 images
  0%|          | 0/391 [00:00<?, ?it/s]  0%|          | 1/391 [00:00<04:34,  1.42it/s]  2%|▏         | 6/391 [00:00<00:41,  9.31it/s]  3%|▎         | 11/391 [00:00<00:23, 16.34it/s]  4%|▍         | 16/391 [00:01<00:16, 22.79it/s]  5%|▌         | 21/391 [00:01<00:13, 28.09it/s]  7%|▋         | 26/391 [00:01<00:11, 31.99it/s]  8%|▊         | 31/391 [00:01<00:10, 35.06it/s]  9%|▉         | 36/391 [00:01<00:09, 37.33it/s] 10%|█         | 41/391 [00:01<00:08, 39.52it/s] 12%|█▏        | 46/391 [00:01<00:08, 41.24it/s] 13%|█▎        | 51/391 [00:01<00:07, 42.85it/s] 14%|█▍        | 56/391 [00:01<00:07, 43.27it/s] 16%|█▌        | 61/391 [00:02<00:08, 38.65it/s] 17%|█▋        | 66/391 [00:02<00:09, 35.82it/s] 18%|█▊        | 70/391 [00:02<00:09, 35.51it/s] 19%|█▉        | 74/391 [00:02<00:09, 35.22it/s] 20%|██        | 79/391 [00:02<00:08, 38.14it/s] 21%|██▏       | 84/391 [00:02<00:07, 40.17it/s] 23%|██▎       | 89/391 [00:02<00:07, 41.69it/s] 24%|██▍       | 94/391 [00:02<00:06, 42.49it/s] 25%|██▌       | 99/391 [00:03<00:06, 43.34it/s] 27%|██▋       | 104/391 [00:03<00:06, 43.41it/s] 28%|██▊       | 109/391 [00:03<00:06, 44.89it/s] 29%|██▉       | 114/391 [00:03<00:06, 45.21it/s] 30%|███       | 119/391 [00:03<00:06, 43.87it/s] 32%|███▏      | 124/391 [00:03<00:06, 44.07it/s] 33%|███▎      | 129/391 [00:03<00:06, 43.61it/s] 34%|███▍      | 134/391 [00:03<00:06, 40.69it/s] 36%|███▌      | 139/391 [00:04<00:06, 37.12it/s] 37%|███▋      | 143/391 [00:04<00:06, 36.11it/s] 38%|███▊      | 147/391 [00:04<00:07, 34.47it/s] 39%|███▉      | 152/391 [00:04<00:06, 36.95it/s] 40%|████      | 157/391 [00:04<00:05, 39.04it/s] 41%|████▏     | 162/391 [00:04<00:05, 40.60it/s] 43%|████▎     | 167/391 [00:04<00:05, 41.25it/s] 44%|████▍     | 173/391 [00:04<00:04, 43.72it/s] 46%|████▌     | 178/391 [00:04<00:04, 43.68it/s] 47%|████▋     | 183/391 [00:05<00:04, 43.44it/s] 48%|████▊     | 188/391 [00:05<00:04, 44.12it/s] 49%|████▉     | 193/391 [00:05<00:04, 44.52it/s] 51%|█████     | 198/391 [00:05<00:04, 44.26it/s] 52%|█████▏    | 203/391 [00:05<00:04, 44.65it/s] 53%|█████▎    | 208/391 [00:05<00:04, 43.48it/s] 54%|█████▍    | 213/391 [00:05<00:04, 38.67it/s] 55%|█████▌    | 217/391 [00:05<00:04, 37.60it/s] 57%|█████▋    | 221/391 [00:06<00:04, 36.17it/s] 58%|█████▊    | 225/391 [00:06<00:04, 36.50it/s] 59%|█████▉    | 230/391 [00:06<00:04, 38.55it/s] 60%|██████    | 235/391 [00:06<00:03, 40.03it/s] 61%|██████▏   | 240/391 [00:06<00:03, 41.84it/s] 63%|██████▎   | 245/391 [00:06<00:03, 42.90it/s] 64%|██████▍   | 250/391 [00:06<00:03, 43.12it/s] 65%|██████▌   | 255/391 [00:06<00:03, 43.77it/s] 66%|██████▋   | 260/391 [00:06<00:02, 43.98it/s] 68%|██████▊   | 265/391 [00:07<00:02, 44.42it/s] 69%|██████▉   | 270/391 [00:07<00:02, 45.36it/s] 70%|███████   | 275/391 [00:07<00:02, 44.77it/s] 72%|███████▏  | 280/391 [00:07<00:02, 44.41it/s] 73%|███████▎  | 285/391 [00:07<00:02, 40.73it/s] 74%|███████▍  | 290/391 [00:07<00:02, 37.06it/s] 75%|███████▌  | 294/391 [00:07<00:02, 36.06it/s] 76%|███████▌  | 298/391 [00:07<00:02, 34.41it/s] 77%|███████▋  | 303/391 [00:08<00:02, 37.16it/s] 79%|███████▉  | 308/391 [00:08<00:02, 39.19it/s] 80%|████████  | 313/391 [00:08<00:01, 40.00it/s] 81%|████████▏ | 318/391 [00:08<00:01, 41.54it/s] 83%|████████▎ | 323/391 [00:08<00:01, 42.12it/s] 84%|████████▍ | 328/391 [00:08<00:01, 42.56it/s] 85%|████████▌ | 333/391 [00:08<00:01, 44.14it/s] 86%|████████▋ | 338/391 [00:08<00:01, 43.71it/s] 88%|████████▊ | 343/391 [00:08<00:01, 43.83it/s] 89%|████████▉ | 348/391 [00:09<00:00, 45.51it/s] 90%|█████████ | 353/391 [00:09<00:00, 45.11it/s] 92%|█████████▏| 358/391 [00:09<00:00, 39.97it/s] 93%|█████████▎| 363/391 [00:09<00:00, 36.61it/s] 94%|█████████▍| 367/391 [00:09<00:00, 36.71it/s] 95%|█████████▍| 371/391 [00:09<00:00, 35.37it/s] 96%|█████████▌| 376/391 [00:09<00:00, 38.11it/s] 97%|█████████▋| 381/391 [00:09<00:00, 40.34it/s] 99%|█████████▊| 386/391 [00:10<00:00, 41.78it/s]100%|██████████| 391/391 [00:10<00:00, 42.52it/s]100%|██████████| 391/391 [00:10<00:00, 38.36it/s]
50000 images processed, 10.322306156158447 seconds used

Processing in-distribution CIFAR-100 images
  0%|          | 0/79 [00:00<?, ?it/s]  1%|▏         | 1/79 [00:00<00:56,  1.38it/s]  8%|▊         | 6/79 [00:00<00:08,  9.09it/s] 14%|█▍        | 11/79 [00:00<00:04, 16.25it/s] 20%|██        | 16/79 [00:01<00:02, 22.68it/s] 28%|██▊       | 22/79 [00:01<00:01, 29.98it/s] 34%|███▍      | 27/79 [00:01<00:01, 33.55it/s] 41%|████      | 32/79 [00:01<00:01, 36.70it/s] 47%|████▋     | 37/79 [00:01<00:01, 38.87it/s] 53%|█████▎    | 42/79 [00:01<00:00, 40.69it/s] 59%|█████▉    | 47/79 [00:01<00:00, 41.98it/s] 66%|██████▌   | 52/79 [00:01<00:00, 42.69it/s] 72%|███████▏  | 57/79 [00:01<00:00, 40.53it/s] 78%|███████▊  | 62/79 [00:02<00:00, 36.96it/s] 84%|████████▎ | 66/79 [00:02<00:00, 36.40it/s] 89%|████████▊ | 70/79 [00:02<00:00, 35.20it/s] 94%|█████████▎| 74/79 [00:02<00:00, 36.14it/s]100%|██████████| 79/79 [00:03<00:00, 10.37it/s]100%|██████████| 79/79 [00:03<00:00, 21.50it/s]
10000 images processed, 3.6979317665100098 seconds used

Saved forget OOD features to cache/resnet34-top5-palm-cache6-ema0.999-b128-e5-lr0.001-wd1e-4-ltboth-bfmbalanced-fl0.2-lora_r8a32d0.05-temp0.08-stage2-inc1/CIFAR-100/forget
Processing out-of-distribution SVHN images
  0%|          | 0/204 [00:00<?, ?it/s]  0%|          | 1/204 [00:00<02:25,  1.39it/s]  2%|▏         | 5/204 [00:00<00:25,  7.77it/s]  4%|▍         | 9/204 [00:00<00:14, 13.80it/s]  6%|▋         | 13/204 [00:01<00:10, 19.04it/s]  8%|▊         | 17/204 [00:01<00:08, 23.37it/s] 10%|█         | 21/204 [00:01<00:06, 26.71it/s] 12%|█▏        | 25/204 [00:01<00:06, 26.77it/s] 14%|█▍        | 29/204 [00:01<00:06, 26.96it/s] 16%|█▌        | 33/204 [00:01<00:06, 27.08it/s] 18%|█▊        | 37/204 [00:01<00:05, 29.52it/s] 21%|██        | 42/204 [00:01<00:04, 33.56it/s] 23%|██▎       | 46/204 [00:02<00:04, 34.45it/s] 25%|██▍       | 50/204 [00:02<00:04, 35.68it/s] 26%|██▋       | 54/204 [00:02<00:04, 36.56it/s] 28%|██▊       | 58/204 [00:02<00:03, 37.29it/s] 30%|███       | 62/204 [00:02<00:03, 37.61it/s] 32%|███▏      | 66/204 [00:02<00:03, 38.07it/s] 35%|███▍      | 71/204 [00:02<00:03, 39.90it/s] 37%|███▋      | 76/204 [00:02<00:03, 39.75it/s] 39%|███▉      | 80/204 [00:02<00:03, 38.64it/s] 41%|████      | 84/204 [00:03<00:03, 34.09it/s] 43%|████▎     | 88/204 [00:03<00:03, 31.53it/s] 45%|████▌     | 92/204 [00:03<00:03, 30.68it/s] 47%|████▋     | 96/204 [00:03<00:03, 31.61it/s] 49%|████▉     | 100/204 [00:03<00:03, 33.51it/s] 51%|█████▏    | 105/204 [00:03<00:02, 35.57it/s] 53%|█████▎    | 109/204 [00:03<00:02, 36.65it/s] 55%|█████▌    | 113/204 [00:03<00:02, 37.43it/s] 58%|█████▊    | 118/204 [00:03<00:02, 40.20it/s] 60%|██████    | 123/204 [00:04<00:02, 39.51it/s] 63%|██████▎   | 128/204 [00:04<00:01, 39.94it/s] 65%|██████▌   | 133/204 [00:04<00:01, 39.67it/s] 68%|██████▊   | 138/204 [00:04<00:01, 39.84it/s] 70%|██████▉   | 142/204 [00:04<00:01, 39.46it/s] 72%|███████▏  | 146/204 [00:04<00:01, 35.06it/s] 74%|███████▎  | 150/204 [00:04<00:01, 33.99it/s] 75%|███████▌  | 154/204 [00:04<00:01, 33.11it/s] 77%|███████▋  | 158/204 [00:05<00:01, 32.75it/s] 80%|███████▉  | 163/204 [00:05<00:01, 34.96it/s] 82%|████████▏ | 168/204 [00:05<00:00, 38.27it/s] 84%|████████▍ | 172/204 [00:05<00:00, 38.12it/s] 87%|████████▋ | 177/204 [00:05<00:00, 39.18it/s] 89%|████████▉ | 182/204 [00:05<00:00, 39.72it/s] 92%|█████████▏| 188/204 [00:05<00:00, 42.53it/s] 95%|█████████▍| 193/204 [00:05<00:00, 41.97it/s] 97%|█████████▋| 198/204 [00:06<00:00, 41.42it/s]100%|█████████▉| 203/204 [00:06<00:00, 41.16it/s]100%|██████████| 204/204 [00:06<00:00, 32.83it/s]
26032 images processed, 6.282654523849487 seconds used

Processing out-of-distribution places365 images
  0%|          | 0/79 [00:00<?, ?it/s]  1%|▏         | 1/79 [00:01<01:19,  1.02s/it]  6%|▋         | 5/79 [00:01<00:13,  5.56it/s] 10%|█         | 8/79 [00:01<00:07,  8.95it/s] 14%|█▍        | 11/79 [00:01<00:05, 12.21it/s] 19%|█▉        | 15/79 [00:01<00:03, 16.41it/s] 24%|██▍       | 19/79 [00:01<00:02, 20.60it/s] 30%|███       | 24/79 [00:01<00:02, 25.71it/s] 37%|███▋      | 29/79 [00:01<00:01, 30.69it/s] 43%|████▎     | 34/79 [00:01<00:01, 33.43it/s] 49%|████▉     | 39/79 [00:02<00:01, 35.59it/s] 54%|█████▍    | 43/79 [00:02<00:00, 36.27it/s] 61%|██████    | 48/79 [00:02<00:00, 37.74it/s] 67%|██████▋   | 53/79 [00:02<00:00, 38.67it/s] 73%|███████▎  | 58/79 [00:02<00:00, 39.33it/s] 80%|███████▉  | 63/79 [00:02<00:00, 39.83it/s] 86%|████████▌ | 68/79 [00:02<00:00, 36.74it/s] 91%|█████████ | 72/79 [00:03<00:00, 33.59it/s] 96%|█████████▌| 76/79 [00:03<00:00, 33.38it/s]100%|██████████| 79/79 [00:03<00:00, 24.61it/s]
10000 images processed, 3.371037721633911 seconds used

Processing out-of-distribution LSUN images
  0%|          | 0/79 [00:00<?, ?it/s]  1%|▏         | 1/79 [00:00<01:01,  1.26it/s]  6%|▋         | 5/79 [00:00<00:10,  6.97it/s] 13%|█▎        | 10/79 [00:01<00:04, 13.99it/s] 19%|█▉        | 15/79 [00:01<00:03, 20.13it/s] 25%|██▌       | 20/79 [00:01<00:02, 25.13it/s] 32%|███▏      | 25/79 [00:01<00:01, 30.13it/s] 38%|███▊      | 30/79 [00:01<00:01, 32.96it/s] 44%|████▍     | 35/79 [00:01<00:01, 35.24it/s] 51%|█████     | 40/79 [00:01<00:01, 36.98it/s] 57%|█████▋    | 45/79 [00:01<00:00, 37.73it/s] 63%|██████▎   | 50/79 [00:02<00:00, 38.72it/s] 70%|██████▉   | 55/79 [00:02<00:00, 36.43it/s] 75%|███████▍  | 59/79 [00:02<00:00, 33.67it/s] 80%|███████▉  | 63/79 [00:02<00:00, 32.47it/s] 85%|████████▍ | 67/79 [00:02<00:00, 32.55it/s] 91%|█████████ | 72/79 [00:02<00:00, 34.85it/s] 97%|█████████▋| 77/79 [00:02<00:00, 36.65it/s]100%|██████████| 79/79 [00:02<00:00, 27.87it/s]
10000 images processed, 2.8569865226745605 seconds used

Processing out-of-distribution iSUN images
  0%|          | 0/70 [00:00<?, ?it/s]  1%|▏         | 1/70 [00:00<00:55,  1.23it/s]  9%|▊         | 6/70 [00:00<00:07,  8.27it/s] 16%|█▌        | 11/70 [00:01<00:03, 14.86it/s] 23%|██▎       | 16/70 [00:01<00:02, 20.62it/s] 30%|███       | 21/70 [00:01<00:01, 25.55it/s] 37%|███▋      | 26/70 [00:01<00:01, 30.62it/s] 44%|████▍     | 31/70 [00:01<00:01, 33.34it/s] 51%|█████▏    | 36/70 [00:01<00:00, 35.52it/s] 59%|█████▊    | 41/70 [00:01<00:00, 37.10it/s] 66%|██████▌   | 46/70 [00:01<00:00, 38.21it/s] 73%|███████▎  | 51/70 [00:02<00:00, 34.21it/s] 79%|███████▊  | 55/70 [00:02<00:00, 32.14it/s] 84%|████████▍ | 59/70 [00:02<00:00, 31.35it/s] 90%|█████████ | 63/70 [00:02<00:00, 32.59it/s] 97%|█████████▋| 68/70 [00:02<00:00, 34.98it/s]100%|██████████| 70/70 [00:02<00:00, 26.54it/s]
8925 images processed, 2.6745119094848633 seconds used

Processing out-of-distribution dtd images
  0%|          | 0/45 [00:00<?, ?it/s]  2%|▏         | 1/45 [00:01<01:01,  1.40s/it]  9%|▉         | 4/45 [00:01<00:12,  3.32it/s] 18%|█▊        | 8/45 [00:01<00:04,  7.47it/s] 24%|██▍       | 11/45 [00:01<00:03, 10.60it/s] 33%|███▎      | 15/45 [00:01<00:02, 14.90it/s] 40%|████      | 18/45 [00:01<00:01, 17.16it/s] 51%|█████     | 23/45 [00:02<00:01, 18.61it/s] 60%|██████    | 27/45 [00:02<00:00, 22.55it/s] 71%|███████   | 32/45 [00:02<00:00, 27.09it/s] 80%|████████  | 36/45 [00:02<00:00, 20.94it/s] 87%|████████▋ | 39/45 [00:02<00:00, 22.14it/s] 93%|█████████▎| 42/45 [00:02<00:00, 23.19it/s]100%|██████████| 45/45 [00:03<00:00, 14.86it/s]
5640 images processed, 3.047727108001709 seconds used

34.12240672111511
/home/shaokun/anaconda3/envs/PPALM/lib/python3.10/site-packages/torchvision/io/image.py:13: UserWarning: Failed to load image Python extension: '/home/shaokun/anaconda3/envs/PPALM/lib/python3.10/site-packages/torchvision/image.so: undefined symbol: _ZN3c1017RegisterOperatorsD1Ev'If you don't plan on using image functionality from `torchvision.io`, you can ignore this warning. Otherwise, there might be something wrong with your environment. Did you have `libjpeg` or `libpng` installed before building `torchvision` from source?
  warn(
/home/shaokun/anaconda3/envs/PPALM/lib/python3.10/site-packages/umap/umap_.py:1952: UserWarning: n_jobs value 1 overridden to 1 by setting random_state. Use no seed for parallelism.
  warn(
/home/shaokun/anaconda3/envs/PPALM/lib/python3.10/site-packages/umap/umap_.py:1952: UserWarning: n_jobs value 1 overridden to 1 by setting random_state. Use no seed for parallelism.
  warn(
Evaluating SVHN
Evaluating places365
Evaluating LSUN
Evaluating iSUN
Evaluating dtd
 OOD detection method: SSD+
              FPR    AUROC  AUIN  
SVHN           2.74  99.29
places365     74.73  79.11
LSUN          20.51  95.38
iSUN          78.34  79.48
dtd           43.60  90.14
AVG           43.98  88.68
Retain-Acc: 0.7087
Forget-as-OOD (retain known vs forget novel):
  FPR: 77.80 AUROC: 84.40 AUIN: 99.01
20.39601731300354
[umap] saved to figs/umap_CIFAR-100_resnet34_top5-palm-cache6-ema0.999-b128-e5-lr0.001-wd1e-4-ltboth-bfmbalanced-fl0.2-lora_r8a32d0.05-temp0.08-stage2-inc1_domain.png
[umap] saved to figs/umap_CIFAR-100_resnet34_top5-palm-cache6-ema0.999-b128-e5-lr0.001-wd1e-4-ltboth-bfmbalanced-fl0.2-lora_r8a32d0.05-temp0.08-stage2-inc1_rf.png
/home/shaokun/anaconda3/envs/PPALM/lib/python3.10/site-packages/torchvision/io/image.py:13: UserWarning: Failed to load image Python extension: '/home/shaokun/anaconda3/envs/PPALM/lib/python3.10/site-packages/torchvision/image.so: undefined symbol: _ZN3c1017RegisterOperatorsD1Ev'If you don't plan on using image functionality from `torchvision.io`, you can ignore this warning. Otherwise, there might be something wrong with your environment. Did you have `libjpeg` or `libpng` installed before building `torchvision` from source?
  warn(
Files already downloaded and verified
Files already downloaded and verified
ckpt loaded from checkpoints/CIFAR-100-resnet34-top5-palm-cache6-ema0.999-with-prototypes.pt
resnet34-top5-palm-cache6-ema0.999-b128-e5-lr0.001-wd1e-4-ltboth-bfmbalanced-fl0.2-lora_r8a32d0.05-temp0.08-stage2-inc2: Number of model parameters: 21843904
Processing in-distribution CIFAR-100 images
  0%|          | 0/391 [00:00<?, ?it/s]  0%|          | 1/391 [00:00<04:42,  1.38it/s]  1%|▏         | 5/391 [00:00<00:51,  7.43it/s]  3%|▎         | 10/391 [00:00<00:26, 14.40it/s]  4%|▎         | 14/391 [00:01<00:20, 18.75it/s]  5%|▍         | 19/391 [00:01<00:14, 24.86it/s]  6%|▌         | 24/391 [00:01<00:12, 29.33it/s]  7%|▋         | 29/391 [00:01<00:10, 33.49it/s]  9%|▊         | 34/391 [00:01<00:09, 36.53it/s] 10%|▉         | 39/391 [00:01<00:09, 38.96it/s] 11%|█▏        | 44/391 [00:01<00:08, 40.78it/s] 13%|█▎        | 49/391 [00:01<00:08, 42.73it/s] 14%|█▍        | 54/391 [00:01<00:07, 43.29it/s] 15%|█▌        | 59/391 [00:02<00:07, 43.69it/s] 16%|█▋        | 64/391 [00:02<00:07, 43.38it/s] 18%|█▊        | 69/391 [00:02<00:07, 43.80it/s] 19%|█▉        | 74/391 [00:02<00:07, 42.06it/s] 20%|██        | 79/391 [00:02<00:08, 37.45it/s] 21%|██        | 83/391 [00:02<00:08, 35.97it/s] 23%|██▎       | 88/391 [00:02<00:08, 37.60it/s] 24%|██▎       | 92/391 [00:02<00:08, 37.10it/s] 25%|██▍       | 97/391 [00:03<00:07, 39.41it/s] 26%|██▌       | 102/391 [00:03<00:07, 41.11it/s] 27%|██▋       | 107/391 [00:03<00:06, 41.64it/s] 29%|██▊       | 112/391 [00:03<00:06, 42.74it/s] 30%|██▉       | 117/391 [00:03<00:06, 42.99it/s] 31%|███       | 122/391 [00:03<00:06, 43.26it/s] 32%|███▏      | 127/391 [00:03<00:05, 44.36it/s] 34%|███▍      | 132/391 [00:03<00:05, 43.33it/s] 35%|███▌      | 137/391 [00:04<00:05, 43.64it/s] 36%|███▋      | 142/391 [00:04<00:05, 43.55it/s] 38%|███▊      | 147/391 [00:04<00:06, 39.29it/s] 39%|███▉      | 152/391 [00:04<00:06, 36.22it/s] 40%|███▉      | 156/391 [00:04<00:06, 36.14it/s] 41%|████      | 160/391 [00:04<00:06, 35.13it/s] 42%|████▏     | 165/391 [00:04<00:06, 37.66it/s] 43%|████▎     | 170/391 [00:04<00:05, 39.79it/s] 45%|████▍     | 175/391 [00:05<00:05, 40.91it/s] 46%|████▌     | 180/391 [00:05<00:05, 42.17it/s] 48%|████▊     | 186/391 [00:05<00:04, 45.47it/s] 49%|████▉     | 191/391 [00:05<00:04, 45.48it/s] 50%|█████     | 196/391 [00:05<00:04, 45.40it/s] 51%|█████▏    | 201/391 [00:05<00:04, 45.46it/s] 53%|█████▎    | 206/391 [00:05<00:04, 45.48it/s] 54%|█████▍    | 211/391 [00:05<00:04, 44.59it/s] 55%|█████▌    | 216/391 [00:05<00:03, 44.91it/s] 57%|█████▋    | 221/391 [00:06<00:03, 42.52it/s] 58%|█████▊    | 226/391 [00:06<00:04, 38.12it/s] 59%|█████▉    | 230/391 [00:06<00:04, 36.66it/s] 60%|█████▉    | 234/391 [00:06<00:04, 35.95it/s] 61%|██████    | 238/391 [00:06<00:04, 36.09it/s] 62%|██████▏   | 243/391 [00:06<00:03, 38.71it/s] 63%|██████▎   | 248/391 [00:06<00:03, 41.48it/s] 65%|██████▍   | 253/391 [00:06<00:03, 42.50it/s] 66%|██████▌   | 258/391 [00:06<00:03, 43.11it/s] 67%|██████▋   | 263/391 [00:07<00:02, 43.75it/s] 69%|██████▊   | 268/391 [00:07<00:02, 43.68it/s] 70%|██████▉   | 273/391 [00:07<00:02, 43.94it/s] 71%|███████   | 278/391 [00:07<00:02, 43.63it/s] 72%|███████▏  | 283/391 [00:07<00:02, 44.18it/s] 74%|███████▎  | 288/391 [00:07<00:02, 44.53it/s] 75%|███████▍  | 293/391 [00:07<00:02, 44.80it/s] 76%|███████▌  | 298/391 [00:07<00:02, 42.09it/s] 77%|███████▋  | 303/391 [00:08<00:02, 37.86it/s] 79%|███████▊  | 307/391 [00:08<00:02, 36.65it/s] 80%|███████▉  | 311/391 [00:08<00:02, 36.36it/s] 81%|████████  | 316/391 [00:08<00:01, 38.65it/s] 82%|████████▏ | 321/391 [00:08<00:01, 40.12it/s] 83%|████████▎ | 326/391 [00:08<00:01, 41.63it/s] 85%|████████▍ | 331/391 [00:08<00:01, 42.22it/s] 86%|████████▌ | 336/391 [00:08<00:01, 42.63it/s] 87%|████████▋ | 341/391 [00:08<00:01, 43.49it/s] 88%|████████▊ | 346/391 [00:09<00:01, 44.17it/s] 90%|████████▉ | 351/391 [00:09<00:00, 43.72it/s] 91%|█████████ | 356/391 [00:09<00:00, 43.97it/s] 92%|█████████▏| 361/391 [00:09<00:00, 43.57it/s] 94%|█████████▎| 366/391 [00:09<00:00, 44.08it/s] 95%|█████████▍| 371/391 [00:09<00:00, 43.44it/s] 96%|█████████▌| 376/391 [00:09<00:00, 40.38it/s] 97%|█████████▋| 381/391 [00:09<00:00, 37.42it/s] 98%|█████████▊| 385/391 [00:10<00:00, 36.90it/s] 99%|█████████▉| 389/391 [00:10<00:00, 36.44it/s]100%|██████████| 391/391 [00:10<00:00, 38.20it/s]
50000 images processed, 10.385325193405151 seconds used

Processing in-distribution CIFAR-100 images
  0%|          | 0/79 [00:00<?, ?it/s]  1%|▏         | 1/79 [00:00<01:04,  1.21it/s]  8%|▊         | 6/79 [00:00<00:08,  8.28it/s] 14%|█▍        | 11/79 [00:01<00:04, 15.07it/s] 20%|██        | 16/79 [00:01<00:02, 21.81it/s] 27%|██▋       | 21/79 [00:01<00:02, 27.34it/s] 33%|███▎      | 26/79 [00:01<00:01, 31.78it/s] 39%|███▉      | 31/79 [00:01<00:01, 35.35it/s] 47%|████▋     | 37/79 [00:01<00:01, 39.66it/s] 53%|█████▎    | 42/79 [00:01<00:00, 41.23it/s] 59%|█████▉    | 47/79 [00:01<00:00, 42.39it/s] 66%|██████▌   | 52/79 [00:01<00:00, 43.29it/s] 72%|███████▏  | 57/79 [00:02<00:00, 43.93it/s] 78%|███████▊  | 62/79 [00:02<00:00, 41.52it/s] 85%|████████▍ | 67/79 [00:02<00:00, 37.68it/s] 90%|████████▉ | 71/79 [00:02<00:00, 36.71it/s] 95%|█████████▍| 75/79 [00:02<00:00, 34.85it/s]100%|██████████| 79/79 [00:02<00:00, 29.48it/s]
10000 images processed, 2.715317964553833 seconds used

Saved forget OOD features to cache/resnet34-top5-palm-cache6-ema0.999-b128-e5-lr0.001-wd1e-4-ltboth-bfmbalanced-fl0.2-lora_r8a32d0.05-temp0.08-stage2-inc2/CIFAR-100/forget
Processing out-of-distribution SVHN images
  0%|          | 0/204 [00:00<?, ?it/s]  0%|          | 1/204 [00:00<02:29,  1.36it/s]  3%|▎         | 6/204 [00:00<00:22,  8.90it/s]  5%|▌         | 11/204 [00:00<00:12, 15.72it/s]  8%|▊         | 16/204 [00:01<00:08, 21.43it/s] 10%|█         | 21/204 [00:01<00:06, 26.18it/s] 12%|█▏        | 25/204 [00:01<00:06, 28.44it/s] 14%|█▍        | 29/204 [00:01<00:06, 28.20it/s] 16%|█▌        | 33/204 [00:01<00:05, 28.75it/s] 18%|█▊        | 37/204 [00:01<00:05, 28.82it/s] 20%|██        | 41/204 [00:01<00:05, 30.70it/s] 23%|██▎       | 46/204 [00:01<00:04, 33.69it/s] 25%|██▌       | 51/204 [00:02<00:04, 35.80it/s] 27%|██▋       | 56/204 [00:02<00:03, 37.14it/s] 29%|██▉       | 60/204 [00:02<00:03, 37.24it/s] 32%|███▏      | 65/204 [00:02<00:03, 38.96it/s] 34%|███▍      | 69/204 [00:02<00:03, 38.56it/s] 36%|███▋      | 74/204 [00:02<00:03, 39.10it/s] 39%|███▊      | 79/204 [00:02<00:03, 39.44it/s] 41%|████      | 83/204 [00:02<00:03, 39.35it/s] 43%|████▎     | 87/204 [00:03<00:02, 39.16it/s] 45%|████▍     | 91/204 [00:03<00:03, 34.71it/s] 47%|████▋     | 95/204 [00:03<00:03, 32.19it/s] 49%|████▊     | 99/204 [00:03<00:03, 32.18it/s] 50%|█████     | 103/204 [00:03<00:03, 32.22it/s] 52%|█████▏    | 107/204 [00:03<00:02, 34.00it/s] 54%|█████▍    | 111/204 [00:03<00:02, 35.55it/s] 57%|█████▋    | 116/204 [00:03<00:02, 38.69it/s] 59%|█████▉    | 120/204 [00:03<00:02, 38.78it/s] 61%|██████    | 124/204 [00:04<00:02, 39.12it/s] 63%|██████▎   | 128/204 [00:04<00:01, 39.14it/s] 65%|██████▌   | 133/204 [00:04<00:01, 39.52it/s] 67%|██████▋   | 137/204 [00:04<00:01, 39.31it/s] 70%|██████▉   | 142/204 [00:04<00:01, 39.86it/s] 72%|███████▏  | 147/204 [00:04<00:01, 39.95it/s] 74%|███████▍  | 151/204 [00:04<00:01, 35.88it/s] 76%|███████▌  | 155/204 [00:04<00:01, 32.84it/s] 78%|███████▊  | 159/204 [00:05<00:01, 32.83it/s] 80%|███████▉  | 163/204 [00:05<00:01, 31.90it/s] 82%|████████▏ | 167/204 [00:05<00:01, 33.83it/s] 84%|████████▍ | 172/204 [00:05<00:00, 35.77it/s] 87%|████████▋ | 177/204 [00:05<00:00, 37.36it/s] 89%|████████▉ | 182/204 [00:05<00:00, 38.53it/s] 92%|█████████▏| 187/204 [00:05<00:00, 39.30it/s] 94%|█████████▍| 192/204 [00:05<00:00, 39.79it/s] 97%|█████████▋| 198/204 [00:06<00:00, 42.82it/s]100%|█████████▉| 203/204 [00:06<00:00, 42.24it/s]100%|██████████| 204/204 [00:06<00:00, 33.01it/s]
26032 images processed, 6.224375486373901 seconds used

Processing out-of-distribution places365 images
  0%|          | 0/79 [00:00<?, ?it/s]  1%|▏         | 1/79 [00:01<01:18,  1.00s/it]  6%|▋         | 5/79 [00:01<00:12,  5.70it/s] 13%|█▎        | 10/79 [00:01<00:05, 11.81it/s] 19%|█▉        | 15/79 [00:01<00:03, 17.57it/s] 24%|██▍       | 19/79 [00:01<00:02, 21.46it/s] 29%|██▉       | 23/79 [00:01<00:02, 23.01it/s] 34%|███▍      | 27/79 [00:01<00:02, 24.34it/s] 39%|███▉      | 31/79 [00:01<00:01, 25.81it/s] 44%|████▍     | 35/79 [00:02<00:01, 28.02it/s] 51%|█████     | 40/79 [00:02<00:01, 33.07it/s] 57%|█████▋    | 45/79 [00:02<00:00, 35.36it/s] 62%|██████▏   | 49/79 [00:02<00:00, 36.12it/s] 68%|██████▊   | 54/79 [00:02<00:00, 37.60it/s] 75%|███████▍  | 59/79 [00:02<00:00, 38.63it/s] 81%|████████  | 64/79 [00:02<00:00, 39.33it/s] 87%|████████▋ | 69/79 [00:02<00:00, 39.98it/s] 94%|█████████▎| 74/79 [00:02<00:00, 40.28it/s]100%|██████████| 79/79 [00:03<00:00, 42.38it/s]100%|██████████| 79/79 [00:03<00:00, 25.76it/s]
10000 images processed, 3.1002585887908936 seconds used

Processing out-of-distribution LSUN images
  0%|          | 0/79 [00:00<?, ?it/s]  1%|▏         | 1/79 [00:00<00:47,  1.63it/s]  6%|▋         | 5/79 [00:00<00:08,  8.75it/s] 11%|█▏        | 9/79 [00:00<00:04, 15.31it/s] 16%|█▋        | 13/79 [00:00<00:03, 20.90it/s] 23%|██▎       | 18/79 [00:01<00:02, 27.77it/s] 29%|██▉       | 23/79 [00:01<00:01, 31.70it/s] 34%|███▍      | 27/79 [00:01<00:01, 30.67it/s] 39%|███▉      | 31/79 [00:01<00:01, 29.44it/s] 44%|████▍     | 35/79 [00:01<00:01, 30.24it/s] 49%|████▉     | 39/79 [00:01<00:01, 29.67it/s] 56%|█████▌    | 44/79 [00:01<00:01, 33.03it/s] 62%|██████▏   | 49/79 [00:01<00:00, 35.29it/s] 68%|██████▊   | 54/79 [00:02<00:00, 36.95it/s] 75%|███████▍  | 59/79 [00:02<00:00, 38.15it/s] 81%|████████  | 64/79 [00:02<00:00, 38.97it/s] 87%|████████▋ | 69/79 [00:02<00:00, 39.58it/s] 94%|█████████▎| 74/79 [00:02<00:00, 41.54it/s]100%|██████████| 79/79 [00:02<00:00, 43.36it/s]100%|██████████| 79/79 [00:02<00:00, 29.88it/s]
10000 images processed, 2.672013998031616 seconds used

Processing out-of-distribution iSUN images
  0%|          | 0/70 [00:00<?, ?it/s]  1%|▏         | 1/70 [00:00<00:56,  1.21it/s]  9%|▊         | 6/70 [00:00<00:07,  8.16it/s] 16%|█▌        | 11/70 [00:01<00:04, 14.74it/s] 21%|██▏       | 15/70 [00:01<00:03, 17.89it/s] 27%|██▋       | 19/70 [00:01<00:02, 20.32it/s] 33%|███▎      | 23/70 [00:01<00:01, 24.15it/s] 39%|███▊      | 27/70 [00:01<00:01, 25.57it/s] 44%|████▍     | 31/70 [00:01<00:01, 28.36it/s] 51%|█████▏    | 36/70 [00:01<00:01, 31.75it/s] 59%|█████▊    | 41/70 [00:01<00:00, 34.67it/s] 66%|██████▌   | 46/70 [00:02<00:00, 36.52it/s] 73%|███████▎  | 51/70 [00:02<00:00, 37.85it/s] 80%|████████  | 56/70 [00:02<00:00, 38.54it/s] 87%|████████▋ | 61/70 [00:02<00:00, 39.30it/s] 94%|█████████▍| 66/70 [00:02<00:00, 39.91it/s]100%|██████████| 70/70 [00:02<00:00, 26.26it/s]
8925 images processed, 2.7046616077423096 seconds used

Processing out-of-distribution dtd images
  0%|          | 0/45 [00:00<?, ?it/s]  2%|▏         | 1/45 [00:01<00:54,  1.24s/it]  4%|▍         | 2/45 [00:01<00:26,  1.63it/s] 16%|█▌        | 7/45 [00:01<00:05,  7.26it/s] 24%|██▍       | 11/45 [00:01<00:02, 11.84it/s] 36%|███▌      | 16/45 [00:01<00:01, 17.94it/s] 44%|████▍     | 20/45 [00:02<00:01, 15.80it/s] 56%|█████▌    | 25/45 [00:02<00:00, 20.64it/s] 67%|██████▋   | 30/45 [00:02<00:00, 25.07it/s] 76%|███████▌  | 34/45 [00:02<00:00, 18.17it/s] 82%|████████▏ | 37/45 [00:02<00:00, 19.84it/s] 93%|█████████▎| 42/45 [00:02<00:00, 24.36it/s]100%|██████████| 45/45 [00:02<00:00, 15.22it/s]
5640 images processed, 2.9777185916900635 seconds used

32.56905174255371
/home/shaokun/anaconda3/envs/PPALM/lib/python3.10/site-packages/torchvision/io/image.py:13: UserWarning: Failed to load image Python extension: '/home/shaokun/anaconda3/envs/PPALM/lib/python3.10/site-packages/torchvision/image.so: undefined symbol: _ZN3c1017RegisterOperatorsD1Ev'If you don't plan on using image functionality from `torchvision.io`, you can ignore this warning. Otherwise, there might be something wrong with your environment. Did you have `libjpeg` or `libpng` installed before building `torchvision` from source?
  warn(
/home/shaokun/anaconda3/envs/PPALM/lib/python3.10/site-packages/umap/umap_.py:1952: UserWarning: n_jobs value 1 overridden to 1 by setting random_state. Use no seed for parallelism.
  warn(
/home/shaokun/anaconda3/envs/PPALM/lib/python3.10/site-packages/umap/umap_.py:1952: UserWarning: n_jobs value 1 overridden to 1 by setting random_state. Use no seed for parallelism.
  warn(
Evaluating SVHN
Evaluating places365
Evaluating LSUN
Evaluating iSUN
Evaluating dtd
 OOD detection method: SSD+
              FPR    AUROC  AUIN  
SVHN           2.64  99.31
places365     73.15  79.36
LSUN          19.62  95.60
iSUN          77.04  79.75
dtd           42.39  90.36
AVG           42.97  88.88
Retain-Acc: 0.7087
Forget-as-OOD (retain known vs forget novel):
  FPR: 69.20 AUROC: 87.58 AUIN: 99.28
14.3048255443573
[umap] saved to figs/umap_CIFAR-100_resnet34_top5-palm-cache6-ema0.999-b128-e5-lr0.001-wd1e-4-ltboth-bfmbalanced-fl0.2-lora_r8a32d0.05-temp0.08-stage2-inc2_domain.png
[umap] saved to figs/umap_CIFAR-100_resnet34_top5-palm-cache6-ema0.999-b128-e5-lr0.001-wd1e-4-ltboth-bfmbalanced-fl0.2-lora_r8a32d0.05-temp0.08-stage2-inc2_rf.png
/home/shaokun/anaconda3/envs/PPALM/lib/python3.10/site-packages/torchvision/io/image.py:13: UserWarning: Failed to load image Python extension: '/home/shaokun/anaconda3/envs/PPALM/lib/python3.10/site-packages/torchvision/image.so: undefined symbol: _ZN3c1017RegisterOperatorsD1Ev'If you don't plan on using image functionality from `torchvision.io`, you can ignore this warning. Otherwise, there might be something wrong with your environment. Did you have `libjpeg` or `libpng` installed before building `torchvision` from source?
  warn(
Files already downloaded and verified
Files already downloaded and verified
ckpt loaded from checkpoints/CIFAR-100-resnet34-top5-palm-cache6-ema0.999-with-prototypes.pt
resnet34-top5-palm-cache6-ema0.999-b128-e5-lr0.001-wd1e-4-ltboth-bfmbalanced-fl0.2-lora_r8a32d0.05-temp0.08-stage2-seen: Number of model parameters: 21843904
Processing in-distribution CIFAR-100 images
  0%|          | 0/391 [00:00<?, ?it/s]  0%|          | 1/391 [00:02<15:54,  2.45s/it]  2%|▏         | 6/391 [00:02<02:03,  3.11it/s]  3%|▎         | 11/391 [00:02<00:58,  6.45it/s]  4%|▍         | 16/391 [00:02<00:36, 10.36it/s]  5%|▌         | 20/391 [00:02<00:27, 13.32it/s]  6%|▌         | 24/391 [00:03<00:22, 16.32it/s]  7%|▋         | 28/391 [00:03<00:18, 19.89it/s]  8%|▊         | 33/391 [00:03<00:14, 24.24it/s]  9%|▉         | 37/391 [00:03<00:13, 26.75it/s] 11%|█         | 42/391 [00:03<00:11, 31.12it/s] 12%|█▏        | 47/391 [00:03<00:09, 34.71it/s] 14%|█▎        | 53/391 [00:03<00:08, 38.82it/s] 15%|█▍        | 58/391 [00:03<00:08, 38.89it/s] 16%|█▌        | 63/391 [00:03<00:08, 40.81it/s] 17%|█▋        | 68/391 [00:04<00:07, 42.52it/s] 19%|█▊        | 73/391 [00:04<00:07, 43.69it/s] 20%|█▉        | 78/391 [00:04<00:07, 43.62it/s] 21%|██        | 83/391 [00:04<00:07, 43.87it/s] 23%|██▎       | 88/391 [00:04<00:06, 43.81it/s] 24%|██▍       | 93/391 [00:04<00:07, 40.96it/s] 25%|██▌       | 98/391 [00:04<00:07, 37.00it/s] 26%|██▌       | 102/391 [00:04<00:07, 36.22it/s] 27%|██▋       | 107/391 [00:05<00:07, 36.88it/s] 28%|██▊       | 111/391 [00:05<00:07, 35.84it/s] 30%|██▉       | 116/391 [00:05<00:07, 38.41it/s] 31%|███       | 121/391 [00:05<00:06, 39.66it/s] 32%|███▏      | 126/391 [00:05<00:06, 41.03it/s] 34%|███▎      | 131/391 [00:05<00:06, 42.89it/s] 35%|███▍      | 136/391 [00:05<00:05, 43.37it/s] 36%|███▌      | 141/391 [00:05<00:05, 44.02it/s] 37%|███▋      | 146/391 [00:05<00:05, 43.91it/s] 39%|███▊      | 151/391 [00:06<00:05, 44.46it/s] 40%|███▉      | 156/391 [00:06<00:05, 43.38it/s] 41%|████      | 161/391 [00:06<00:05, 44.00it/s] 42%|████▏     | 166/391 [00:06<00:04, 45.23it/s] 44%|████▎     | 171/391 [00:06<00:05, 39.48it/s] 45%|████▌     | 176/391 [00:06<00:05, 36.34it/s] 46%|████▌     | 180/391 [00:06<00:05, 35.93it/s] 47%|████▋     | 184/391 [00:06<00:05, 35.55it/s] 48%|████▊     | 189/391 [00:07<00:05, 38.28it/s] 50%|████▉     | 194/391 [00:07<00:04, 40.27it/s] 51%|█████     | 199/391 [00:07<00:04, 41.94it/s] 52%|█████▏    | 204/391 [00:07<00:04, 42.68it/s] 53%|█████▎    | 209/391 [00:07<00:04, 43.47it/s] 55%|█████▍    | 214/391 [00:07<00:04, 44.04it/s] 56%|█████▌    | 219/391 [00:07<00:03, 44.45it/s] 57%|█████▋    | 224/391 [00:07<00:03, 44.73it/s] 59%|█████▊    | 229/391 [00:07<00:03, 45.95it/s] 60%|█████▉    | 234/391 [00:08<00:03, 45.92it/s] 61%|██████    | 239/391 [00:08<00:03, 45.47it/s] 62%|██████▏   | 244/391 [00:08<00:03, 43.64it/s] 64%|██████▎   | 249/391 [00:08<00:03, 38.71it/s] 65%|██████▍   | 253/391 [00:08<00:03, 36.51it/s] 66%|██████▌   | 257/391 [00:08<00:03, 35.46it/s] 67%|██████▋   | 261/391 [00:08<00:03, 35.57it/s] 68%|██████▊   | 266/391 [00:08<00:03, 37.85it/s] 69%|██████▉   | 271/391 [00:09<00:03, 39.32it/s] 71%|███████   | 276/391 [00:09<00:02, 40.84it/s] 72%|███████▏  | 281/391 [00:09<00:02, 41.86it/s] 73%|███████▎  | 286/391 [00:09<00:02, 42.94it/s] 75%|███████▍  | 292/391 [00:09<00:02, 44.93it/s] 76%|███████▌  | 297/391 [00:09<00:02, 44.04it/s] 77%|███████▋  | 302/391 [00:09<00:02, 44.18it/s] 79%|███████▊  | 307/391 [00:09<00:01, 44.31it/s] 80%|███████▉  | 312/391 [00:09<00:01, 44.59it/s] 81%|████████  | 317/391 [00:10<00:01, 42.95it/s] 82%|████████▏ | 322/391 [00:10<00:01, 38.08it/s] 83%|████████▎ | 326/391 [00:10<00:01, 35.87it/s] 84%|████████▍ | 330/391 [00:10<00:01, 36.29it/s] 85%|████████▌ | 334/391 [00:10<00:01, 35.03it/s] 87%|████████▋ | 339/391 [00:10<00:01, 37.48it/s] 88%|████████▊ | 344/391 [00:10<00:01, 39.25it/s] 89%|████████▉ | 349/391 [00:10<00:01, 40.54it/s] 91%|█████████ | 355/391 [00:11<00:00, 43.79it/s] 92%|█████████▏| 360/391 [00:11<00:00, 44.02it/s] 93%|█████████▎| 365/391 [00:11<00:00, 44.41it/s] 95%|█████████▍| 370/391 [00:11<00:00, 44.72it/s] 96%|█████████▌| 375/391 [00:11<00:00, 44.92it/s] 97%|█████████▋| 380/391 [00:11<00:00, 45.08it/s] 98%|█████████▊| 385/391 [00:11<00:00, 45.26it/s]100%|█████████▉| 390/391 [00:11<00:00, 45.32it/s]100%|██████████| 391/391 [00:11<00:00, 32.87it/s]
50000 images processed, 11.998541593551636 seconds used

Processing in-distribution CIFAR-100 images
  0%|          | 0/79 [00:00<?, ?it/s]  1%|▏         | 1/79 [00:00<00:45,  1.72it/s]  8%|▊         | 6/79 [00:00<00:06, 10.90it/s] 14%|█▍        | 11/79 [00:00<00:03, 18.76it/s] 20%|██        | 16/79 [00:00<00:02, 25.22it/s] 27%|██▋       | 21/79 [00:01<00:01, 30.75it/s] 33%|███▎      | 26/79 [00:01<00:01, 34.13it/s] 39%|███▉      | 31/79 [00:01<00:01, 36.83it/s] 46%|████▌     | 36/79 [00:01<00:01, 35.44it/s] 51%|█████     | 40/79 [00:01<00:01, 33.33it/s] 56%|█████▌    | 44/79 [00:01<00:01, 34.25it/s] 61%|██████    | 48/79 [00:01<00:00, 33.46it/s] 67%|██████▋   | 53/79 [00:01<00:00, 35.74it/s] 73%|███████▎  | 58/79 [00:02<00:00, 38.42it/s] 80%|███████▉  | 63/79 [00:02<00:00, 40.38it/s] 86%|████████▌ | 68/79 [00:02<00:00, 41.82it/s] 92%|█████████▏| 73/79 [00:02<00:00, 42.86it/s] 99%|█████████▊| 78/79 [00:02<00:00, 43.62it/s]100%|██████████| 79/79 [00:02<00:00, 31.86it/s]
10000 images processed, 2.5187549591064453 seconds used

Saved forget OOD features to cache/resnet34-top5-palm-cache6-ema0.999-b128-e5-lr0.001-wd1e-4-ltboth-bfmbalanced-fl0.2-lora_r8a32d0.05-temp0.08-stage2-seen/CIFAR-100/forget
Processing out-of-distribution SVHN images
  0%|          | 0/204 [00:00<?, ?it/s]  0%|          | 1/204 [00:00<02:35,  1.30it/s]  2%|▏         | 5/204 [00:00<00:28,  7.00it/s]  4%|▍         | 8/204 [00:01<00:18, 10.82it/s]  6%|▌         | 12/204 [00:01<00:11, 16.26it/s]  7%|▋         | 15/204 [00:01<00:10, 18.77it/s]  9%|▉         | 19/204 [00:01<00:07, 23.58it/s] 12%|█▏        | 24/204 [00:01<00:06, 27.98it/s] 14%|█▍        | 29/204 [00:01<00:05, 31.74it/s] 17%|█▋        | 34/204 [00:01<00:04, 34.43it/s] 19%|█▉        | 39/204 [00:01<00:04, 36.34it/s] 22%|██▏       | 44/204 [00:01<00:04, 37.54it/s] 24%|██▍       | 49/204 [00:02<00:04, 38.56it/s] 26%|██▋       | 54/204 [00:02<00:03, 39.60it/s] 29%|██▉       | 59/204 [00:02<00:03, 39.93it/s] 31%|███▏      | 64/204 [00:02<00:03, 39.79it/s] 34%|███▍      | 69/204 [00:02<00:03, 35.10it/s] 36%|███▌      | 73/204 [00:02<00:04, 32.71it/s] 38%|███▊      | 77/204 [00:02<00:04, 31.64it/s] 40%|███▉      | 81/204 [00:03<00:03, 32.69it/s] 42%|████▏     | 85/204 [00:03<00:03, 34.31it/s] 44%|████▍     | 90/204 [00:03<00:03, 36.28it/s] 46%|████▌     | 94/204 [00:03<00:02, 37.04it/s] 49%|████▊     | 99/204 [00:03<00:02, 38.32it/s] 50%|█████     | 103/204 [00:03<00:02, 38.31it/s] 53%|█████▎    | 108/204 [00:03<00:02, 40.54it/s] 55%|█████▌    | 113/204 [00:03<00:02, 40.38it/s] 58%|█████▊    | 118/204 [00:03<00:02, 40.37it/s] 60%|██████    | 123/204 [00:04<00:01, 41.60it/s] 63%|██████▎   | 128/204 [00:04<00:01, 40.70it/s] 65%|██████▌   | 133/204 [00:04<00:02, 35.22it/s] 67%|██████▋   | 137/204 [00:04<00:02, 33.40it/s] 69%|██████▉   | 141/204 [00:04<00:01, 32.28it/s] 71%|███████   | 145/204 [00:04<00:01, 33.10it/s] 74%|███████▎  | 150/204 [00:04<00:01, 35.11it/s] 75%|███████▌  | 154/204 [00:04<00:01, 35.92it/s] 78%|███████▊  | 159/204 [00:05<00:01, 37.47it/s] 80%|███████▉  | 163/204 [00:05<00:01, 38.10it/s] 82%|████████▏ | 168/204 [00:05<00:00, 39.02it/s] 84%|████████▍ | 172/204 [00:05<00:00, 38.98it/s] 87%|████████▋ | 177/204 [00:05<00:00, 41.86it/s] 89%|████████▉ | 182/204 [00:05<00:00, 41.22it/s] 92%|█████████▏| 187/204 [00:05<00:00, 40.77it/s] 94%|█████████▍| 192/204 [00:05<00:00, 41.36it/s] 97%|█████████▋| 197/204 [00:06<00:00, 35.58it/s] 99%|█████████▊| 201/204 [00:06<00:00, 33.87it/s]100%|██████████| 204/204 [00:06<00:00, 32.50it/s]
26032 images processed, 6.317777395248413 seconds used

Processing out-of-distribution places365 images
  0%|          | 0/79 [00:00<?, ?it/s]  1%|▏         | 1/79 [00:00<01:14,  1.04it/s]  5%|▌         | 4/79 [00:01<00:15,  4.72it/s]  9%|▉         | 7/79 [00:01<00:08,  8.47it/s] 13%|█▎        | 10/79 [00:01<00:05, 12.20it/s] 16%|█▋        | 13/79 [00:01<00:04, 15.62it/s] 23%|██▎       | 18/79 [00:01<00:02, 22.05it/s] 29%|██▉       | 23/79 [00:01<00:01, 28.13it/s] 35%|███▌      | 28/79 [00:01<00:01, 32.05it/s] 42%|████▏     | 33/79 [00:01<00:01, 34.29it/s] 48%|████▊     | 38/79 [00:01<00:01, 36.07it/s] 54%|█████▍    | 43/79 [00:02<00:00, 37.50it/s] 59%|█████▉    | 47/79 [00:02<00:00, 37.75it/s] 66%|██████▌   | 52/79 [00:02<00:00, 38.91it/s] 72%|███████▏  | 57/79 [00:02<00:00, 39.56it/s] 78%|███████▊  | 62/79 [00:02<00:00, 39.98it/s] 85%|████████▍ | 67/79 [00:02<00:00, 35.14it/s] 90%|████████▉ | 71/79 [00:02<00:00, 32.71it/s] 95%|█████████▍| 75/79 [00:03<00:00, 33.01it/s]100%|██████████| 79/79 [00:03<00:00, 25.33it/s]
10000 images processed, 3.150402069091797 seconds used

Processing out-of-distribution LSUN images
  0%|          | 0/79 [00:00<?, ?it/s]  1%|▏         | 1/79 [00:00<01:00,  1.29it/s]  5%|▌         | 4/79 [00:00<00:13,  5.73it/s] 11%|█▏        | 9/79 [00:00<00:05, 13.22it/s] 18%|█▊        | 14/79 [00:01<00:03, 19.60it/s] 24%|██▍       | 19/79 [00:01<00:02, 24.94it/s] 29%|██▉       | 23/79 [00:01<00:01, 28.22it/s] 35%|███▌      | 28/79 [00:01<00:01, 31.81it/s] 42%|████▏     | 33/79 [00:01<00:01, 34.27it/s] 48%|████▊     | 38/79 [00:01<00:01, 36.26it/s] 54%|█████▍    | 43/79 [00:01<00:00, 39.00it/s] 61%|██████    | 48/79 [00:01<00:00, 39.65it/s] 67%|██████▋   | 53/79 [00:02<00:00, 40.03it/s] 73%|███████▎  | 58/79 [00:02<00:00, 35.18it/s] 78%|███████▊  | 62/79 [00:02<00:00, 35.77it/s] 85%|████████▍ | 67/79 [00:02<00:00, 37.64it/s] 91%|█████████ | 72/79 [00:02<00:00, 38.84it/s] 97%|█████████▋| 77/79 [00:02<00:00, 39.67it/s]100%|██████████| 79/79 [00:02<00:00, 28.81it/s]
10000 images processed, 2.7642219066619873 seconds used

Processing out-of-distribution iSUN images
  0%|          | 0/70 [00:00<?, ?it/s]  1%|▏         | 1/70 [00:00<00:53,  1.28it/s]  7%|▋         | 5/70 [00:00<00:08,  7.24it/s] 14%|█▍        | 10/70 [00:01<00:04, 14.43it/s] 21%|██▏       | 15/70 [00:01<00:02, 20.63it/s] 29%|██▊       | 20/70 [00:01<00:01, 25.72it/s] 36%|███▌      | 25/70 [00:01<00:01, 29.72it/s] 43%|████▎     | 30/70 [00:01<00:01, 32.98it/s] 49%|████▊     | 34/70 [00:01<00:01, 31.16it/s] 54%|█████▍    | 38/70 [00:01<00:00, 32.95it/s] 63%|██████▎   | 44/70 [00:01<00:00, 37.64it/s] 70%|███████   | 49/70 [00:01<00:00, 38.66it/s] 77%|███████▋  | 54/70 [00:02<00:00, 39.35it/s] 84%|████████▍ | 59/70 [00:02<00:00, 39.91it/s] 91%|█████████▏| 64/70 [00:02<00:00, 40.25it/s] 99%|█████████▊| 69/70 [00:02<00:00, 40.48it/s]100%|██████████| 70/70 [00:02<00:00, 28.03it/s]
8925 images processed, 2.5312271118164062 seconds used

Processing out-of-distribution dtd images
  0%|          | 0/45 [00:00<?, ?it/s]  2%|▏         | 1/45 [00:01<00:57,  1.30s/it]  4%|▍         | 2/45 [00:01<00:27,  1.59it/s] 11%|█         | 5/45 [00:01<00:08,  4.87it/s] 20%|██        | 9/45 [00:01<00:03,  9.86it/s] 31%|███       | 14/45 [00:01<00:01, 16.15it/s] 40%|████      | 18/45 [00:01<00:01, 18.69it/s] 51%|█████     | 23/45 [00:02<00:00, 23.80it/s] 62%|██████▏   | 28/45 [00:02<00:00, 28.05it/s] 73%|███████▎  | 33/45 [00:02<00:00, 20.51it/s] 80%|████████  | 36/45 [00:02<00:00, 19.43it/s] 87%|████████▋ | 39/45 [00:02<00:00, 20.84it/s] 96%|█████████▌| 43/45 [00:02<00:00, 24.23it/s]100%|██████████| 45/45 [00:03<00:00, 14.89it/s]
5640 images processed, 3.0527472496032715 seconds used

34.14167308807373
/home/shaokun/anaconda3/envs/PPALM/lib/python3.10/site-packages/torchvision/io/image.py:13: UserWarning: Failed to load image Python extension: '/home/shaokun/anaconda3/envs/PPALM/lib/python3.10/site-packages/torchvision/image.so: undefined symbol: _ZN3c1017RegisterOperatorsD1Ev'If you don't plan on using image functionality from `torchvision.io`, you can ignore this warning. Otherwise, there might be something wrong with your environment. Did you have `libjpeg` or `libpng` installed before building `torchvision` from source?
  warn(
/home/shaokun/anaconda3/envs/PPALM/lib/python3.10/site-packages/umap/umap_.py:1952: UserWarning: n_jobs value 1 overridden to 1 by setting random_state. Use no seed for parallelism.
  warn(
/home/shaokun/anaconda3/envs/PPALM/lib/python3.10/site-packages/umap/umap_.py:1952: UserWarning: n_jobs value 1 overridden to 1 by setting random_state. Use no seed for parallelism.
  warn(
Evaluating SVHN
Evaluating places365
Evaluating LSUN
Evaluating iSUN
Evaluating dtd
 OOD detection method: SSD+
              FPR    AUROC  AUIN  
SVHN           2.57  99.36
places365     68.08  81.18
LSUN          17.82  96.07
iSUN          72.36  81.80
dtd           38.48  91.38
AVG           39.86  89.96
Retain-Acc: 0.7481
Forget-as-OOD (retain known vs forget novel):
  FPR: 54.60 AUROC: 89.30 AUIN: 98.64
16.317912578582764
[umap] saved to figs/umap_CIFAR-100_resnet34_top5-palm-cache6-ema0.999-b128-e5-lr0.001-wd1e-4-ltboth-bfmbalanced-fl0.2-lora_r8a32d0.05-temp0.08-stage2-seen_domain.png
[umap] saved to figs/umap_CIFAR-100_resnet34_top5-palm-cache6-ema0.999-b128-e5-lr0.001-wd1e-4-ltboth-bfmbalanced-fl0.2-lora_r8a32d0.05-temp0.08-stage2-seen_rf.png
